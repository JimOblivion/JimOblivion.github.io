{"meta":{"title":"Oblivion","subtitle":"","description":"","author":"Jim Oblivion","url":"http://jimoblivion.github.io","root":"/"},"pages":[{"title":"æ–‡ç« å½’æ¡£","date":"2023-07-12T06:02:30.429Z","updated":"2023-07-12T06:02:30.429Z","comments":true,"path":"archive.html","permalink":"http://jimoblivion.github.io/archive.html","excerpt":"","text":""},{"title":"about","date":"2023-07-11T15:04:50.000Z","updated":"2023-07-24T09:30:58.977Z","comments":true,"path":"about/index.html","permalink":"http://jimoblivion.github.io/about/index.html","excerpt":"","text":"å…³äºæˆ‘ ğŸ‘¨â€ğŸ’» ç¨‹åºçŒ¿ ğŸŠâ€ æ¸¸æ³³ ğŸ• ç¾é£Ÿ å…³äºæœ¬ç«™ âœ¨ Kubernetes ğŸ’– java ğŸ webå‰ç«¯ ğŸŒ shell ğŸ¤– AI"}],"posts":[{"title":"Kubernetesé™çº§","slug":"Kubernetesé™çº§","date":"2023-07-24T08:18:29.000Z","updated":"2023-07-24T08:38:31.881Z","comments":true,"path":"2023/07/24/Kubernetesé™çº§/","link":"","permalink":"http://jimoblivion.github.io/2023/07/24/Kubernetes%E9%99%8D%E7%BA%A7/","excerpt":"","text":"åŸå› ä¸å°å¿ƒç›´æ¥yum -y updateå°†k8så’Œdockerçš„ç»„ä»¶è¿›è¡Œäº†å‡çº§ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è¿›è¡Œé™çº§ å¸è½½k8s æŸ¥çœ‹å·²ç»å®‰è£…çš„k8sç»„ä»¶ 1yum list installed | grep kube å°†æŸ¥åˆ°çš„k8sç»„ä»¶è¿›è¡Œå¸è½½ 1rpm -e kubelet.x86_64 kubeadm.x86_64 kubectl.x86_64 kubernetes-cni.x86_64 cri-tools.x86_64 å¸è½½docker æŸ¥çœ‹å·²ç»å®‰è£…çš„dockerç»„ä»¶ 1yum list installed | grep docker å°†æŸ¥åˆ°çš„dockerç»„ä»¶è¿›è¡Œå¸è½½ 1rpm -e docker-buildx-plugin.x86_64 containerd.io.x86_64 docker-ce.x86_64 docker-ce-cli.x86_64 docker-ce-rootless-extras.x86_64 docker-compose-plugin.x86_64 å®‰è£…docker å®‰è£…è„šæœ¬ 1yum install -y docker-ce-20.10.0-3.el7 è®¾ç½®è‡ªå¯åŠ¨ 12systemctl start dockersystemctl enable docker å®‰è£…k8s å®‰è£…è„šæœ¬ 1yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0 è§£å†³é‡å¯è™šæ‹ŸæœºåæŠ¥é”™çš„é—®é¢˜ 1vi /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf 1234[Service]CPUAccounting=true ## æ·»åŠ  CPUAccounting=true é€‰é¡¹ï¼Œå¼€å¯ systemd CPU ç»Ÿè®¡åŠŸèƒ½MemoryAccounting=true ## æ·»åŠ  MemoryAccounting=true é€‰é¡¹ï¼Œå¼€å¯ systemd Memory ç»Ÿè®¡åŠŸèƒ½Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot; 12systemctl daemon-reloadsystemctl restart kubelet å…¶ä»–é—®é¢˜å¤„ç† é—®é¢˜æè¿° æ‰§è¡Œkubectl -n monitoring top podæŠ¥é”™ Metrics not available for pod monitoring&#x2F;alertmanager-main-0, age: 2h51m31.584335184s é‡æ–°å®‰è£…ç»„ä»¶ 1wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.2/components.yaml -O metrics-server-components.yaml ç¼–è¾‘æ–‡ä»¶ï¼Œæ‰¾åˆ°containersè¿›è¡Œä¿®æ”¹ 1vim metrics-server-components.yaml 12345678910spec: containers: - args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --kubelet-use-node-status-port - --metric-resolution=15s - --kubelet-insecure-tls # é»˜è®¤ä¸ä½¿ç”¨https image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.2 # ä½¿ç”¨å›½å†…é•œåƒåœ°å€ é‡æ–°å®‰è£…å·¥å…· 1kubectl apply -f metrics-server-components.yaml æŸ¥çœ‹å·¥å…·çŠ¶æ€ 1kubectl get po --all-namespaces | grep metrics æ¢å¤æ­£å¸¸","categories":[{"name":"Kuberneteså®‰è£…","slug":"Kuberneteså®‰è£…","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%89%E8%A3%85/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåä¸€ï¼‰ï¼šç›‘æ§æ–¹æ¡ˆ","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåä¸€ï¼‰ï¼šç›‘æ§æ–¹æ¡ˆ","date":"2023-07-24T01:50:05.000Z","updated":"2023-07-24T08:18:41.777Z","comments":true,"path":"2023/07/24/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåä¸€ï¼‰ï¼šç›‘æ§æ–¹æ¡ˆ/","link":"","permalink":"http://jimoblivion.github.io/2023/07/24/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%E5%8D%81%E4%B8%80%EF%BC%89%EF%BC%9A%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88/","excerpt":"","text":"Heapster(ä¸€èˆ¬ä¸æ¨èä½¿ç”¨)123Heapsteræ˜¯å®¹å™¨é›†ç¾¤ç›‘æ§å’Œæ€§èƒ½åˆ†æå·¥å…·ï¼Œå¤©ç„¶æ”¯æŒkuberneteså’ŒCoreOSã€‚kubernetesæœ‰ä¸ªå‡ºåçš„ç›‘æ§agent---cAdvisorã€‚åœ¨æ¯ä¸ªkubernetes Nodeä¸Šéƒ½ä¼šè¿è¡ŒcDvisorã€‚ä»–ä¼šæ”¶é›†æœ¬æœºä»¥åŠå®¹å™¨çš„ç›‘æ§æ•°æ®ã€‚åœ¨è¾ƒæ–°ç‰ˆæœ¬ä¸­ï¼Œk8så·²ç»å°†cAdvisoråŠŸèƒ½é›†æˆåˆ°kubeletç»„ä»¶ä¸­ã€‚æ¯ä¸ªNodeèŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿›è¡Œwebè®¿é—® Weave scope ä¸ä½¿ç”¨jenkinsçš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡Œè‡ªåŠ¨åŒ–CDã€‚ 1234567Weave Scopeå¯ä»¥ç›‘æ§kubernetesé›†ç¾¤ä¸­çš„ä¸€ç³»åˆ—èµ„æºçš„çŠ¶æ€ã€èµ„æºä½¿ç”¨æƒ…å†µã€åº”ç”¨æ‹“æ‰‘ã€scaleã€è¿˜å¯ä»¥ç›´æ¥é€šè¿‡æµè§ˆå™¨è¿›è¡Œå®¹å™¨å†…éƒ¨è°ƒè¯•ç­‰ï¼Œå…¶æä¾›çš„åŠŸèƒ½åŒ…æ‹¬: â€¢ äº¤äº’å¼æ‹“æ‰‘ç•Œé¢ â€¢ å›¾å½¢æ¨¡å¼å’Œè¡¨æ ¼æ¨¡å¼ â€¢ è¿‡æ»¤åŠŸèƒ½ â€¢ å®æ—¶åº¦é‡ â€¢ å®¹å™¨æ’é”™ â€¢ æ’ä»¶æ‰©å±• Prometheuså®‰è£… æ¨èä½¿ç”¨kube-prometheusè¿›è¡Œå®‰è£… ä»githubä¸‹è½½èµ„æºï¼Œæ³¨æ„ç‰ˆæœ¬åŒ¹é…ï¼Œæˆ‘ä»¬ä½¿ç”¨release-0.11ã€‚ 1wget https://github.com/prometheus-operator/kube-prometheus/archive/refs/tags/v0.11.0.tar.gz è§£å‹ç¼© 12tar -zxvf v0.11.0.tar.gzcd kube-prometheus-0.11.0/ å¯¹é…ç½®è¿›è¡Œä¿®æ”¹ 123456sed -i &#x27;s/quay.io/quay.mirrors.ustc.edu.cn/g&#x27; ./manifests/prometheusOperator-deployment.yamlsed -i &#x27;s/quay.io/quay.mirrors.ustc.edu.cn/g&#x27; ./manifests/prometheusOperator-prometheusRule.yamlsed -i &#x27;s/quay.io/quay.mirrors.ustc.edu.cn/g&#x27; ./manifests/alertmanager-alertmanager.yamlsed -i &#x27;s/quay.io/quay.mirrors.ustc.edu.cn/g&#x27; ./manifests/kubeStateMetrics-deployment.yamlsed -i &#x27;s/k8s.gcr.io/lank8s.cn/g&#x27; ./manifests/kubeStateMetrics-deployment.yamlsed -i &#x27;s/quay.io/quay.mirrors.ustc.edu.cn/g&#x27; ./manifests/nodeExporter-daemonset.yaml æ„å»º 12kubectl create -f ./manifests/setup/kubectl apply -f ./manifests/ æŸ¥çœ‹ç›‘æ§PodçŠ¶æ€ 1kubectl get po -n monitoring å‡ºç°é•œåƒæ‹‰å–å¤±è´¥ è§£å†³é•œåƒæ‹‰å–å¤±è´¥é—®é¢˜ å¯¹podè¿›è¡Œæè¿° 1kubectl -n monitoring describe po prometheus-adapter-6455646bdc-84pxh æè¿°podï¼Œå¯ä»¥çŸ¥é“æ‹‰å–é•œåƒå¤±è´¥ï¼Œä»¥åŠé•œåƒçš„ç‰ˆæœ¬prometheus-adapter:v0.9.1ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡dockerè·å–prometheus-adapterçš„é•œåƒ^ 1docker search prometheus-adapter æ ¹æ®æè¿°æ‹‰å–é€‚åˆçš„é•œåƒåˆ°æœ¬åœ° 1docker pull lbbi/prometheus-adapter:v0.9.1 ç»™ä¸‹è½½ä¸‹æ¥çš„é•œåƒæ‰“æ ‡ç­¾ 1docker images | grep prometheus-adapter 1docker tag docker.io/lbbi/prometheus-adapter:v0.9.1 k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1 ä¿®æ”¹prometheu adapterçš„yamlæ–‡ä»¶ 1vim prometheusAdapter-deployment.yaml 12image: k8s.gcr.io/prometheus-adapter/prometheus-adapter:v0.9.1 imagePullPolicy: Never # è®©k8sä»æœ¬åœ°è·å–é•œåƒ æŸ¥çœ‹æœ¬åœ°podè¿è¡ŒçŠ¶æ€ 1kubectl -n monitoring get po æŸ¥çœ‹é•œåƒçš„SVC æ­¤æ—¶ç›´æ¥è®¿é—®ä¼šå¤±è´¥ï¼Œéœ€è¦ä¿®æ”¹SVCç±»å‹ï¼Œå¹¶ä¸”ä½¿ç”¨ingressæ¥è®¿é—® 1kubectl -n monitoring get svc å¯ç”¨ç«¯å£æš´éœ²æœåŠ¡ 1vim ./alertmanager-service.yaml 12345678910111213141516spec: ports: - name: web port: 9093 targetPort: web nodePort: 30082 # ä¿®æ”¹ - name: reloader-web port: 8080 targetPort: reloader-web selector: app.kubernetes.io/component: alert-router app.kubernetes.io/instance: main app.kubernetes.io/name: alertmanager app.kubernetes.io/part-of: kube-prometheus sessionAffinity: ClientIP type: NodePort # ä¿®æ”¹ 1kubectl apply -f ./alertmanager-service.yaml 1vim grafana-service.yaml 1234567891011spec: ports: - name: http port: 3000 targetPort: http nodePort: 30081 # ä¿®æ”¹ selector: app.kubernetes.io/component: grafana app.kubernetes.io/name: grafana app.kubernetes.io/part-of: kube-prometheus type: NodePort # ä¿®æ”¹ 1kubectl apply -f grafana-service.yaml 1vim ./prometheus-service.yaml 12345678910111213141516spec: ports: - name: web port: 9090 targetPort: web - name: reloader-web port: 8080 targetPort: reloader-web nodePort: 30080 # ä¿®æ”¹ selector: app.kubernetes.io/component: prometheus app.kubernetes.io/instance: k8s app.kubernetes.io/name: prometheus app.kubernetes.io/part-of: kube-prometheus sessionAffinity: ClientIP type: NodePort # ä¿®æ”¹ 1kubectl apply -f prometheus-service.yaml æŒ‚è½½å¤±è´¥é—®é¢˜åˆ—è§£å†³ æŸ¥çœ‹æ—¥å¿—ï¼Œå‡ºç°å¦‚ä¸‹é”™è¯¯ Error: MountVolume.SetUp failed for volume &quot;config-volume&quot; 1vim prometheus-prometheus.yaml è§£å†³åŠæ³•ç»“å°¾æ–°å¢å¦‚ä¸‹é…ç½® 123456789serviceMonitorSelector: &#123;&#125;retention: 3dstorage: volumeClaimTemplate: spec: storageClassName: managed-nfs-storage resources: requests: storage: 2Gi è®¿é—®æ™®ç½—ç±³ä¿®æ–¯æœåŠ¡ï¼Œè®¿é—®ä¸é€š 1curl 192.168.1.20:32101 å†…éƒ¨å¯ä»¥è®¿é—®ä½†æ˜¯ä»å¤–éƒ¨æ— æ³•è®¿é—®æœåŠ¡ æ¨æµ‹æ˜¯å› ä¸ºç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´ å‚è€ƒ prometheus readiness probe keeps on failing Â· Issue #9179 Â· prometheus&#x2F;prometheus (github.com) 1kubectl -n monitoring logs -f prometheus-k8s-0 æ¸…ç†éƒ¨åˆ†æ— ç”¨çš„pvåï¼Œä¾ç„¶æ— æ³•è®¿é—®ï¼Œä½†æ˜¯æ­¤æ—¶æŸ¥çœ‹podçš„æè¿°ï¼Œå¼‚å¸¸å·²ç»æ¶ˆå¤±ã€‚ è§‚å¯Ÿå‘ç°podè¢«éƒ¨ç½²åˆ°äº†k8snode1èŠ‚ç‚¹ä¸Šï¼Œäºæ˜¯åˆ°k8snode1èŠ‚ç‚¹ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œå‘ç°å¯ä»¥è®¿é—®é€šè¿‡ è§£å†³åŠæ³•ï¼š ç»™nodeèŠ‚ç‚¹æ‰“æ ‡ç­¾ï¼Œä½¿ç”¨èŠ‚ç‚¹äº²å’Œæ€§ï¼Œç„¶åè®©podè¢«é©±é€åˆ°masterèŠ‚ç‚¹ä¸Šã€‚ 12kubectl label no k8snode1 node=slaverkubectl label no node node=master æŸ¥çœ‹æ ‡ç­¾ 1kubectl get node --show-labels | grep node= 1vim alertmanager-alertmanager.yaml 123456789affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: node operator: In values: - master 1kubectl apply -f alertmanager-alertmanager.yaml é€æ¸éƒ¨ç½²åˆ°äº†nodeèŠ‚ç‚¹ä¹‹ä¸Š æ­¤æ—¶åœ¨ä¸»èŠ‚ç‚¹å·²ç»å¯ä»¥æ­£å¸¸è®¿é—® åŒç†ä¿®æ”¹ prometheus-prometheus.yamlå’Œ grafana-deployment.yaml æ‰§è¡Œå®Œæˆåï¼Œå‡ºç°å¡é¡¿ç°è±¡ã€‚ æŸ¥çœ‹æ—¥å¿—å‡ºç°äº†å¦‚ä¸‹é”™è¯¯ï¼Œ â€œError updating node status, will retryâ€ err&#x3D;â€error getting node &quot;k8snode1&quot; è¿™ä¸ªé—®é¢˜ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´æŠ¥é”™è‡ªå·±å°±æ¶ˆå¤±äº†â€¦â€¦ é…ç½®ingressä½¿ç”¨åŸŸåè®¿é—®ç›‘æ§æœåŠ¡ åˆ›å»ºingress 1vim prometheus-ingress.yaml 1234567891011121314151617181920212223242526272829303132333435363738apiVersion: networking.k8s.io/v1kind: Ingressmetadata: namespace: monitoring name: prometheus-ingressspec: ingressClassName: nginx rules: - host: grafana.zy.cn http: paths: - path: / pathType: Prefix backend: service: name: grafana port: number: 3000 - host: prometheus.zy.cn http: paths: - path: / pathType: Prefix backend: service: name: prometheus-k8s port: number: 9090 - host: alertmanager.zy.cn http: paths: - path: / pathType: Prefix backend: service: name: altermanager-main # é…ç½®æ‹¼å†™é”™è¯¯ åé¢ä¼šæœ‰é—®é¢˜æ’æŸ¥ port: number: 9093 1kubectl apply -f prometheus-ingress.yaml æŸ¥çœ‹æˆ‘ä»¬çš„ingress 1kubectl -n monitoring get ingress æ­¤æ—¶åœ¨æˆ‘ä»¬contoså’Œæˆ‘ä»¬æœ¬åœ°ç”µè„‘hostsä¸­æ·»åŠ åŸŸåé…ç½® 123192.168.1.20 grafana.zy.cn192.168.1.20 prometheus.zy.cn192.168.1.20 alertmanager.zy.cn é…ç½®å®Œæˆåå°±å¯ä»¥ä½¿ç”¨åŸŸåè¿›è¡Œè®¿é—®äº†ã€‚ è®¿é—®åŸŸå è®¿é—® http://prometheus.zy.cn/ è®¿é—® http://grafana.zy.cn/login ä½†æ˜¯æ­¤æ—¶è®¿é—®http://alertmanager.zy.cn/ å‡ºç°äº†503é”™è¯¯ã€‚ æŸ¥çœ‹alertmanagerçš„podçš„æè¿°å‘ç°æ¢é’ˆæŠ¥é”™ æœ€ç»ˆç»è¿‡æµ‹è¯•åœ¨èŠ‚ç‚¹ä¸Šä¹Ÿæ— æ³•é€šè¿‡åŸŸåè®¿é—®ï¼Œç»è¿‡ä»”ç»†æ’æŸ¥å‘ç°éœ€è¦å¯¹prometheus-ingress.yamlè¿›è¡Œä¿®æ”¹ï¼š 12345678910- host: alertmanager.zy.cn http: paths: - path: / pathType: Prefix backend: service: name: alertmanager-main # æ­¤å¤„æ‹¼å†™é”™è¯¯ä¼šå¯¼è‡´æˆ‘ä»¬æœ€ç»ˆè®¿é—®åŸŸåå’Œæˆ‘ä»¬svcçš„nameä¸ä¸€è‡´ï¼Œå¯¼è‡´æ— æ³•è®¿é—® port: number: 9093 æ‰§è¡Œ 1kubectl apply -f prometheus-ingress.yaml æ­¤æ—¶è®¿é—® http://alertmanager.zy.cn/ ï¼Œç«™ç‚¹æ¢å¤ æ€»ç»“ï¼šç»†èŠ‚å†³å®šæˆè´¥ã€‚","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"Prometheus","slug":"Prometheus","permalink":"http://jimoblivion.github.io/tags/Prometheus/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰ï¼šHelmåŒ…ç®¡ç†","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰ï¼šHelmåŒ…ç®¡ç†","date":"2023-07-23T14:41:17.000Z","updated":"2023-07-24T01:50:23.470Z","comments":true,"path":"2023/07/23/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰ï¼šHelmåŒ…ç®¡ç†/","link":"","permalink":"http://jimoblivion.github.io/2023/07/23/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%E5%8D%81%EF%BC%89%EF%BC%9AHelm%E5%8C%85%E7%AE%A1%E7%90%86/","excerpt":"","text":"kubernetesåŒ…ç®¡ç†å™¨helmæ˜¯æŸ¥æ‰¾ã€åˆ†äº«å’Œä½¿ç”¨è½¯ä»¶æ„å»ºkubernetesçš„æœ€ä¼˜æ–¹å¼ã€‚ æ¦‚å¿µ123456helmç®¡ç†åä¸ºchartçš„kubernetesåŒ…çš„å·¥å…·ï¼ŒHelmå¯ä»¥åšä»¥ä¸‹çš„äº‹æƒ…ï¼š â€¢ ä»å¤´å¼€å§‹åˆ›å»ºæ–°çš„chart â€¢ å°†chartæ‰“åŒ…æˆå½’æ¡£ï¼ˆtgzï¼‰æ–‡ä»¶ â€¢ äºå­˜å‚¨chartçš„é•¿è£¤è¿›è¡Œäº¤äº’ â€¢ åœ¨ç°æœ‰çš„kubernetesé›†ç¾¤ä¸­å®‰è£…å’Œå¸è½½chart â€¢ ç®¡ç†äºhelmä¸€èµ·å®‰è£…çš„chartçš„å‘å¸ƒå‘¨æœŸ 1234helmçš„ä¸‰ä¸ªæ¦‚å¿µ: â€¢ chartåˆ›å»ºkubernetesåº”ç”¨ç¨‹åºæ‰€å¿…é¡»çš„ä¸€ç»„ä¿¡æ¯ â€¢ configåŒ…å«äº†å¯ä»¥åˆå¹¶åˆ°æ‰“åŒ…çš„chartä¸­çš„é…ç½®ä¿¡æ¯ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªå¯å‘å¸ƒçš„å¯¹è±¡ â€¢ releaseæ˜¯ä¸€ä¸ªä¸ç‰¹å®šé…ç½®ç›¸ç»“åˆçš„chartçš„è¿è¡Œå®ä¾‹ å®‰è£…å®‰è£…è§ingresså®è·µä¸­helmå®‰è£…ï¼šKuberneteså®æˆ˜ç¬”è®°ï¼ˆåï¼‰ï¼šIngress å‘½ä»¤12345678910111213helmå¸¸ç”¨å‘½ä»¤ï¼š - helm repo åˆ—å‡ºã€å¢åŠ ã€æ›´æ–°ã€åˆ é™¤chartä»“åº“ - helm search ä½¿ç”¨å…³é”®è¯æœç´¢chart - helm pull æ‹‰å–è¿œç¨‹ä»“åº“ä¸­çš„chart - helm create åœ¨æœ¬åœ°åˆ›å»ºæ–°çš„chart - helm dependency ç®¡ç†chartä¾èµ– - helm install å®‰è£…chart - helm list åˆ—å‡ºæ‰€æœ‰release - helm lint æ£€æŸ¥charté…ç½®æ˜¯å¦æœ‰è¯¯ - helm package æ‰“åŒ…æœ¬åœ°chart - helm rollback å›æ»šreleaseçš„å†å²ç‰ˆæœ¬ - helm uninstall å¸è½½release - helm upgrade å‡çº§release ä»“åº“è®¾ç½® æŸ¥çœ‹é»˜è®¤ä»“åº“ 1helm repo list æ·»åŠ ä»“åº“ 123helm repo add bitnami https://charts.bitnami.com/bitnamihelm repo add aliyunhub https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/helm repo add azure https://mirror.azure.cn/kubernetes/charts åˆ©ç”¨helmå®Œæˆredisæ„å»º æœç´¢redis chart 1helm search repo redis DEPRECATEDè¯´æ˜å·²ç»æ˜¯å¼ƒç”¨ç‰ˆæœ¬ï¼Œä¸æ¨èä½¿ç”¨ æŸ¥çœ‹å®‰è£…è¯´æ˜ 1helm show readme bitnami/redis ä¿®æ”¹é…ç½®å®‰è£… å…ˆå°†chartæ‹‰åˆ°æœ¬åœ°ï¼Œchartså°±æ˜¯k8sè¦åˆ›å»ºåº”ç”¨çš„ä¸€å †yamlæ–‡ä»¶ã€‚ 1helm pull bitnami/redis è§£å‹æ–‡ä»¶ï¼Œä¿®æ”¹redis&#x2F;values.yamlä¸­çš„å‚æ•° 1tar -xvf redis-17.11.6.tgz ä¿®æ”¹storageClassä¸ºmanaged-nfs-storage 1storageClass: &quot;managed-nfs-storage&quot; è®¾ç½®rediså…å¯†password 12redis: password: &quot;123&quot; ä¿®æ”¹é›†ç¾¤æ¶æ„architechureï¼Œé»˜è®¤æ˜¯ä¸»ä»ï¼ˆreplicationï¼Œ3ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºstandaloneå•æœºæ¨¡å¼ 1architecture: standalone ä¿®æ”¹å®ä¾‹å­˜å‚¨å¤§å°persistence.sizeä¸ºéœ€è¦çš„å¤§å° 12enabled: true size: 1Gi ä¿®æ”¹service.nodePorts.rediså‘å¤–æš´éœ²ç«¯å£, èŒƒå›´30000~32767 12nodePorts: redis: &quot;&quot; åˆ›å»ºå‘½åç©ºé—´ 1kubectl create namespace redis å®‰è£…åˆ°redisçš„å‘½åç©ºé—´ä¸Š 1helm install redis ./redis/ -n redis æŸ¥çœ‹redisçš„èµ„æº 1kubectl -n redis get all 1kubectl get pv 1kubectl get pvc è¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œæ‰§è¡Œredis-cliå‘½ä»¤ 1kubectl -n redis exec -it redis-master-0 -- bash å‡çº§å’Œå›æ»š æƒ³è¦å‡çº§chartå¯ä»¥ä¿®æ”¹æœ¬åœ°charté…ç½® å¹¶æ‰§è¡Œ 1helm upgrade redis ./redis/ -n redis ä½¿ç”¨helm lsçš„å‘½ä»¤æŸ¥çœ‹å½“å‰è¿è¡Œçš„chartçš„releaseç‰ˆæœ¬ï¼Œå¹¶ä½¿ç”¨å‘½ä»¤å›æ»šåˆ°å†å²ç‰ˆæœ¬ 1helm ls æŸ¥çœ‹æŒ‡å®šå‘½åç©ºé—´çš„æŒ‡å®šchart 1helm history redis -n redis å›é€€åˆ°æŒ‡å®šçš„ç‰ˆæœ¬ 1helm rollback redis 1 -n redis helmå¸è½½ å¸è½½ 1helm -n redis delete redis åˆ é™¤å®Œæˆä¹‹åPVCè¿˜åœ¨ 1kubectl get pvc -n redis åˆ é™¤pvc 1kubectl -n redis delete pvc redis-data-redis-master-0 redis-data-redis-replicas-0","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"helm","slug":"helm","permalink":"http://jimoblivion.github.io/tags/helm/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¹ï¼‰ï¼šèº«ä»½è®¤è¯å’Œæƒé™","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¹ï¼‰ï¼šèº«ä»½è®¤è¯å’Œæƒé™","date":"2023-07-23T13:45:06.000Z","updated":"2023-07-23T15:41:41.424Z","comments":true,"path":"2023/07/23/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¹ï¼‰ï¼šèº«ä»½è®¤è¯å’Œæƒé™/","link":"","permalink":"http://jimoblivion.github.io/2023/07/23/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B9%9D%EF%BC%89%EF%BC%9A%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E5%92%8C%E6%9D%83%E9%99%90/","excerpt":"","text":"è®¤è¯æœºåˆ¶kubernetesä¸­æä¾›äº†è‰¯å¥½çš„å¤šç§Ÿæˆ·è®¤è¯ç®¡ç†æœºåˆ¶ï¼Œå¦‚RBACã€ServiceAccountè¿˜æœ‰å„ç§ç­–ç•¥ç­‰ã€‚ /usr/lib/systemd/system/kubelet.service é€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥çœ‹åˆ°å·²ç»é…ç½®äº†RBACè®¿é—®æ§åˆ¶ã€‚ åˆ›å»ºå‚è€ƒ Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäº”ï¼‰ï¼šStorageClasså­˜å‚¨ç±» è®¤è¯Service Account Admission Controller12345678910æ‰€æœ‰kubernetesé›†ç¾¤æœ‰ä¸¤ç±»ç”¨æˆ·ï¼šç”±kubernetesç®¡ç†çš„Service Account(æœåŠ¡è´¦æˆ·)å’ŒUser Account(æ™®é€šè´¦æˆ·)ç»„æˆã€‚æ™®é€šè´¦æˆ·æ˜¯å‡å®šè¢«å¤–éƒ¨æˆ–è€…ç‹¬ç«‹æœåŠ¡ç®¡ç†çš„ï¼Œç”±ç®¡ç†å‘˜åˆ†é…keysï¼Œç”¨æˆ·åƒä½¿ç”¨keystoneæˆ–googleè´¦æˆ·ä¸€æ ·ï¼Œè¢«å­˜å‚¨åœ¨åŒ…å«usernameså’Œpasswordsçš„listçš„æ–‡ä»¶é‡Œã€‚æ³¨æ„ï¼šåœ¨kubernetesä¸­ä¸èƒ½é€šè¿‡APIè°ƒç”¨å°†æ™®é€šç”¨æˆ·æ·»åŠ åˆ°é›†ç¾¤ä¸­ã€‚ â€¢ æ™®é€šè´¦æˆ·é’ˆå¯¹ç”¨æˆ·çš„ï¼ŒæœåŠ¡è´¦æˆ·é’ˆå¯¹Podè¿›ç¨‹ â€¢ æ™®é€šè´¦æˆ·æ—¶å…¨å±€æ€§ï¼Œåœ¨é›†ç¾¤æ‰€æœ‰namespacesä¸­ï¼Œåç§°å…·æœ‰å”¯ä¸€æ€§ â€¢ é€šå¸¸ï¼Œé›†ç¾¤çš„æ™®é€šè´¦æˆ·å¯ä»¥ä¸ä¼ä¸šæ•°æ®åº“åŒæ­¥ï¼Œæ–°çš„æ™®é€šè´¦æˆ·åˆ›å»ºéœ€è¦ç‰¹æ®Šæƒé™ã€‚æœåŠ¡è´¦æˆ·åˆ›å»ºç›®çš„æ˜¯æ›´è½»é‡åŒ–ï¼Œå…è®¸é›†ç¾¤ç”¨æˆ·ä¸ºç‰¹å®šä»»åŠ¡åˆ›å»ºæœåŠ¡è´¦æˆ·ã€‚ â€¢ æ™®é€šè´¦æˆ·å’ŒæœåŠ¡è´¦æˆ·çš„å®¡æ ¸æ³¨æ„äº‹é¡¹ä¸åŒã€‚ â€¢ å¯¹äºå¤æ‚ç³»ç»Ÿ çš„é…ç½®ï¼Œå¯ä»¥åŒ…æ‹¬å¯¹ç³»ç»Ÿçš„å„ç§ç»„ä»¶çš„æœåŠ¡è´¦æˆ·çš„å®šä¹‰ã€‚ Token Controller1234567é€šè¿‡Admission Controller æ’ä»¶æ¥å®ç°å¯¹Podä¿®æ”¹ï¼Œä»–æ˜¯apiserverçš„ä¸€éƒ¨åˆ†ã€‚åˆ›å»ºæˆ–æ›´æ–°podæ—¶ä¼šåŒæ­¥è¿›è¡Œä¿®æ”¹podã€‚å½“æ’ä»¶å¤„äºæ¿€æ´»çŠ¶æ€åˆ›å»ºæˆ–ä¿®æ”¹Podæ—¶ï¼Œä¼šæŒ‰ä»¥ä¸‹æ“ä½œæ‰§è¡Œï¼š â€¢ å¦‚æœpodæ²¡æœ‰è®¾ç½®ServiceAccountï¼Œ åˆ™å°†ServiceAccountè®¾ç½®ä¸ºdefault â€¢ ç¡®ä¿podå¼•ç”¨ServiceAccountå­˜åœ¨ï¼Œå¦åˆ™å°†ä¼šæ‹’ç»è¯·æ±‚ â€¢ å¦‚æœpodä¸åŒ…å«ä»»ä½•ImagePullSercetsï¼Œåˆ™å°†ServiceAccountçš„ImagePullSercetsæ·»åŠ åˆ°podä¸­ â€¢ ä¸ºåŒ…å«APIè®¿é—®Tokençš„podæ·»åŠ ä»¥æ¶volume â€¢ æŠŠvolumeSourceæ·»åŠ åˆ°å®‰è£…åœ¨podçš„æ¯ä¸ªå®¹å™¨ä¸­ï¼ŒæŒ‚è½½åœ¨/var/run/secrets/kubernetes.io/serviceaccount æŸ¥çœ‹ç³»ç»Ÿè´¦æˆ· kubectl get sa æŸ¥çœ‹ç³»ç»Ÿæƒé™ kubectl get as -n kube-system Role1ä»£è¡¨ä¸€ä¸ªè§’è‰²ï¼Œä¼šåŒ…å«ä¸€ç»„æƒé™ï¼Œæ²¡æœ‰æ‹’ç»è§„åˆ™ï¼Œåªæ˜¯é™„åŠ å…è®¸ã€‚å®ƒæ˜¯namespaceçº§åˆ«çš„èµ„æºï¼Œåªèƒ½ä½œç”¨ä¸namespaceä¹‹å†…ã€‚ æŸ¥çœ‹å·²æœ‰çš„è§’è‰²ä¿¡æ¯ kubectl -n ingress-nginx get role -o yaml ClusterRole1åŠŸèƒ½å’ŒRoleä¸€æ ·ï¼ŒåŒºåˆ«æ—¶èµ„æºç±»å‹ä¸ºé›†ç¾¤ç±»å‹ï¼Œè€ŒRoleåªåœ¨namespace æŸ¥çœ‹é›†ç¾¤è§’è‰² kubectl get clusterrole æŸ¥çœ‹æŸä¸ªé›†ç¾¤è§’è‰²ä¿¡æ¯ kubectl get clusterrole view -o yaml RoleBinding123Roleæˆ–ClusterRoleåªæ˜¯ç”¨äºæŒ‡å®šæƒé™é›†åˆï¼Œå…·ä½“ä½œç”¨ä¸ä»€ä¹ˆå¯¹è±¡ä¸Šï¼Œéœ€è¦ä½¿ç”¨RoleBindingæ¥è¿›è¡Œç»‘å®šã€‚ä½œç”¨äºnamespaceå†…ï¼Œå¯ä»¥å°†Roleæˆ–è€…ClusterRoleç»‘å®šåˆ°Userã€Groupã€Service Accountä¸Šã€‚ æŸ¥çœ‹rolebindingä¿¡æ¯ kubectl get rolebinding --all-namespaces æŸ¥çœ‹æŒ‡å®šrolebindingçš„é…ç½®ä¿¡æ¯ kubectl get rolebinding leader-locking-nfs-subdir-external-provisioner -o yaml","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"RBAC","slug":"RBAC","permalink":"http://jimoblivion.github.io/tags/RBAC/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…«ï¼‰ï¼šæ±¡ç‚¹ã€å®¹å¿å’Œäº²å’ŒåŠ›","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…«ï¼‰ï¼šæ±¡ç‚¹ã€å®¹å¿å’Œäº²å’ŒåŠ›","date":"2023-07-21T09:10:16.000Z","updated":"2023-07-23T14:37:17.194Z","comments":true,"path":"2023/07/21/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…«ï¼‰ï¼šæ±¡ç‚¹ã€å®¹å¿å’Œäº²å’ŒåŠ›/","link":"","permalink":"http://jimoblivion.github.io/2023/07/21/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E5%85%AB%EF%BC%89%EF%BC%9A%E6%B1%A1%E7%82%B9%E3%80%81%E5%AE%B9%E5%BF%8D%E5%92%8C%E4%BA%B2%E5%92%8C%E5%8A%9B/","excerpt":"","text":"æ±¡ç‚¹å’Œå®¹å¿åº¦åŸºäºæ±¡ç‚¹çš„é©±é€: é€šè¿‡æ±¡ç‚¹å’Œå®¹å¿åº¦ï¼Œå¯ä»¥çµæ´»åœ°è®©podé¿å¼€æŸäº›èŠ‚ç‚¹æˆ–è€…å°†podä»æŸäº›èŠ‚ç‚¹é©±é€ã€‚ å¦‚æœPodä¸èƒ½å¿å—è¿™ç±»æ±¡ç‚¹ï¼ŒPodä¼šé©¬ä¸Šè¢«é©±é€ å¦‚æœPodèƒ½å¿å—è¿™ç±»æ±¡ç‚¹ï¼Œä½†æ˜¯å®¹å¿åº¦ä¸­æ²¡æœ‰æŒ‡å®štolerationSecondsï¼Œ åˆ™Podè¿˜ä¼šä¸€ç›´åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ å¦‚æœPodèƒ½å¿å—è¿™ç±»æ±¡ç‚¹ï¼Œè€Œä¸”æŒ‡å®šäº†tolerationSeconds, åˆ™Podè¿˜èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œåˆ°æŒ‡å®šçš„æ—¶é—´é•¿åº¦ã€‚ å½“æŸç§æ¡ä»¶ä¸ºçœŸæ—¶ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ã€‚å½“å‰å†…ç½®æ±¡ç‚¹åŒ…æ‹¬ï¼š Not-ready: èŠ‚ç‚¹æœªå‡†å¤‡å¥½ Unreachable: èŠ‚ç‚¹æ§åˆ¶å™¨è®¿é—®ä¸åˆ°èŠ‚ç‚¹ Memory-pressure: èŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ› Disk-pressure: èŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ› Pid-pressure: èŠ‚ç‚¹çš„PIDå‹åŠ› Network-pressure: èŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨ Unschedulable: èŠ‚ç‚¹ä¸å¯è°ƒåº¦ Uninitialized: å¦‚æœkubeletå¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ªäº‘å¹³å°é©±åŠ¨ï¼Œå®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹æ ‡å¿—ä½ä¸å¯ç”¨ã€‚åœ¨cloud-controller-managerçš„ä¸€ä¸ªæ§åˆ¶å™¨åˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹åï¼Œkubeletå°†åˆ é™¤è¿™ä¸ªæ±¡ç‚¹ã€‚ taintæ±¡ç‚¹ æ ‡æ³¨åœ¨èŠ‚ç‚¹ä¸Šï¼Œå½“æˆ‘ä»¬åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ‰“ä¸Šæ±¡ç‚¹ä»¥åï¼Œk8sä¼šä»»åŠ¡å°½é‡ä¸è¦å°†podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œæ’é™¤è¯¥podä¸Šé¢ä¾¿æ˜¯å¯ä»¥å®¹å¿è¯¥æ±¡ç‚¹ï¼Œä¸”ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ‰“å¤šä¸ªæ±¡ç‚¹ï¼Œæ­¤æ—¶åˆ™éœ€è¦podå®¹å¿æ‰€æœ‰æ±¡ç‚¹è¯¥èŠ‚ç‚¹æ‰ä¼šè¢«è°ƒåº¦ã€‚ æ±¡ç‚¹çš„å½±å“ï¼š NoSchedule: ä¸èƒ½å®¹å¿çš„podä¸èƒ½è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œä½†æ˜¯å·²ç»å­˜åœ¨çš„èŠ‚ç‚¹ä¸ä¼šè¢«é©±é€ NoExecute: ä¸èƒ½å®¹å¿çš„èŠ‚ç‚¹ä¼šè¢«ç«‹å³æ¸…é™¤ï¼Œèƒ½å®¹å¿ä¸”æ²¡æœ‰é…ç½® tolerationSeconds: æœªè®¾ç½®ï¼Œåˆ™å¯ä»¥ä¸€ç›´è¿è¡Œï¼›è®¾ç½®äº†3600å±æ€§ï¼Œåˆ™è¯¥podè¿˜èƒ½ç»§ç»­åœ¨è¯¥èŠ‚ç‚¹ç»§ç»­è¿è¡Œ3600ç§’ tolerationå®¹å¿ æ ‡æ³¨åœ¨Podä¸Šï¼Œå½“podè¢«è°ƒåº¦æ—¶ï¼Œå¦‚æœæ²¡æœ‰é…ç½®é…ç½®å®¹å¿ï¼Œåˆ™è¯¥podä¸ä¼šè¢«è°ƒåº¦åˆ°æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰è¯¥podä¸Šæ ‡æ³¨äº†æ»¡è¶³æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰æ±¡ç‚¹ï¼Œåˆ™ä¼šè¢«è°ƒåº¦åˆ°è¿™äº›èŠ‚ç‚¹ã€‚ æ¯”è¾ƒæ“ä½œç±»å‹ Equal: åˆ™æ„å‘³ç€å¿…é¡»ä¸æ±¡ç‚¹å€¼åšåŒ¹é…ï¼Œkey&#x2F;valueéƒ½å¿…é¡»ç›¸åŒï¼Œæ‰è¡¨ç¤ºèƒ½å¤Ÿå®¹å¿è¯¥æ±¡ç‚¹ Exists: å®¹å¿ä¸æ±¡ç‚¹çš„æ¯”è¾ƒkeyï¼Œä¸æ¯”è¾ƒvalueï¼Œ ä¸å…³ç³»valueæ˜¯ä»€ä¹ˆï¼Œåªè¦keyå­˜åœ¨ï¼Œå°±è¡¨ç¤ºå¯ä»¥å®¹å¿ æ±¡ç‚¹ ç»™èŠ‚ç‚¹æ‰“ä¸Šæ±¡ç‚¹ 1kubectl taint no k8snode1 memory=low:NoSchedule Podæ­£å¸¸è¿è¡Œï¼Œ æ­¤æ—¶åŸæœ¬å·²ç»è¿è¡Œçš„Podä¸å—å½±å“ 1kubectl -n zy-test get po -o wide å¯¹Nodeè¿›è¡Œæè¿° 1kubectl -n zy-test describe no k8snode1 åˆ é™¤Pod 1kubectl -n zy-test delete po nginx-deploy-787859bfbd-j2v5p æŸ¥çœ‹èŠ‚ç‚¹Podï¼Œå› ä¸ºæ²¡æœ‰å¯ç”¨èŠ‚ç‚¹æ‰€ä»¥æ–°Podä¼šä¸€ç›´å¤„äºPendingçŠ¶æ€ 1kubectl -n zy-test get po -o wide åˆ é™¤æ±¡ç‚¹ 1kubectl taint no k8snode1 memory=low:NoSchedule- æŸ¥çœ‹èŠ‚ç‚¹å®¹å™¨çŠ¶æ€ï¼Œpodå·²ç»æ¢å¤åœ¨k8snode1èŠ‚ç‚¹ä¸Šè¿è¡Œ 1kubectl -n zy-test get po -o wide å®¹å¿ ç¼–è¾‘deploy, è®©podå¯ä»¥å®¹å¿memory&#x3D;lowçš„æ ‡ç­¾ã€‚ 1kubectl -n zy-test edit deploy nginx-deploy 1234567891011template: metadata: creationTimestamp: null labels: app: nginx-deploy spec: tolerations: - key: &quot;memory&quot; operator: &quot;Equal&quot; value: &quot;low&quot; effect: &quot;NoSchedule&quot; ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾ 1kubectl taint no k8snode1 memory=low:NoSchedule æŸ¥çœ‹æœ€æ–°podå¹¶ä¸”åˆ é™¤ åˆ é™¤pod 1kubectl -n zy-test delete po nginx-deploy-75b764c64b-xdtd4 æŸ¥çœ‹podåˆåœ¨å½“å‰èŠ‚ç‚¹åˆ›å»ºäº†æ–°çš„pod 1kubectl -n zy-test get po -o wide ä¿®æ”¹operatorä¸ºExitsï¼Œå’ŒEqualåŒç†ï¼ŒèŠ‚ç‚¹Podè¿˜æ˜¯å¯ä»¥æ­£å¸¸åˆ›å»º 1234tolerations:- effect: NoSchedule key: memory operator: Exists ä¿®æ”¹ å»é™¤æ±¡ç‚¹ 1kubectl taint no k8snode1 memory=low:NoSchedule- ä¿®æ”¹ 1kubectl -n zy-test edit deploy nginx-deploy 1234tolerations:- effect: NoExecute key: memory operator: Exists æ–°å¢æ±¡ç‚¹ 1kubectl taint no k8snode1 memory=low:NoExecute æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼Œå› ä¸ºnginx-deployæ·»åŠ äº†å®¹å¿æ‰€ä»¥å¯ä»¥å­˜æ´»ï¼Œå…¶ä»–podåˆ™è¢«é©±é€ 1kubectl -n zy-test get po -o wide ä¿®æ”¹nginx-deployæ–°å¢å‚æ•° 1kubectl -n zy-test edit deploy nginx-deploy 12345tolerations:- effect: NoExecute key: memory operator: Exists tolerationSeconds: 15 ç­‰å¾…15ç§’åï¼ŒæŸ¥çœ‹Podçš„è¿è¡ŒçŠ¶æ€ï¼Œå‡ºç°Podé¢‘ç¹è¢«é”€æ¯é‡æ–°åˆ›å»ºçš„æƒ…å†µ 1kubectl -n zy-test get po -o wide å»æ‰æ±¡ç‚¹ 1kubectl taint no k8snode1 memory=low:NoExecute- æŸ¥çœ‹podè¿è¡Œæƒ…å†µ äº²å’ŒåŠ›Affinityäº²å’ŒåŠ› ç±»ä¼¼äºnodeSelectorï¼Œå®ƒä½¿ä½ å¯ä»¥æ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾æ¥çº¦æŸPodå¯ä»¥è°ƒåº¦åˆ°é‚£äº›èŠ‚ç‚¹ä¸Š: requireDuringSchedulingIgnoredDuringExecution: è°ƒåº¦å™¨åªæœ‰åœ¨è§„åˆ™è¢«æ»¡è¶³çš„æ—¶å€™æ‰èƒ½æ‰§è¡Œè°ƒåº¦ã€‚ preferredDuringSchedulingIgnoredDuringExecution: è°ƒåº¦å™¨ä¼šå°è¯•å¯»æ‰¾æ»¡è¶³å¯¹åº”è§„åˆ™çš„èŠ‚ç‚¹ã€‚å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„èŠ‚ç‚¹ï¼Œè°ƒåº¦å™¨ä»ç„¶ä¼šè°ƒåº¦è¯¥pod. åŒ¹é…ç±»å‹: In æ»¡è¶³ä¸€ä¸ªå°±è¡Œ NotIn ä¸€ä¸ªéƒ½ä¸èƒ½æ»¡è¶³ï¼Œåäº²å’Œæ€§ Exists åªè¦å­˜åœ¨ï¼Œå°±æ»¡è¶³ DoesNotExist åªæœ‰å­˜åœ¨ï¼Œæ‰æ»¡è¶³ Gt å¿…é¡»è¦å¤§äºèŠ‚ç‚¹ä¸Š æ•°å€¼æ‰æ»¡è¶³ Lt å¿…é¡»å°äºèŠ‚ç‚¹ä¸Šçš„æ•°å€¼æ‰æ»¡è¶³ èŠ‚ç‚¹çš„äº²å’Œæ€§ åˆ é™¤masterçš„æ±¡ç‚¹æ ‡ç­¾ï¼Œè®©masterä¹Ÿå¯ä»¥è°ƒåº¦ Taints: node-role.kubernetes.io/master:NoSchedule 1kubectl taint no node node-role.kubernetes.io/master:NoSchedule- ç»™k8snode1èŠ‚ç‚¹æ‰“æ ‡ç­¾ 1kubectl label no k8snode1 kubernetes.io/os=linux 12kubectl label no node label-1=key-1kubectl label no k8snode1 label-2=key-2 ç¼–è¾‘deploy 1kubectl -n zy-test edit deploy nginx-deploy 123456789101112131415161718192021222324252627282930template: metadata: creationTimestamp: null labels: app: nginx-deploy spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/os operator: In values: - linux preferredDuringSchedulingIgnoredDuringExecution: - weight: 1 preference: matchExpressions: - key: label-1 operator: In values: - key-1 - weight: 50 # æƒé‡è¶Šé«˜ï¼Œåç»­è°ƒåˆ°è¿™ä¸ªèŠ‚ç‚¹çš„å¯èƒ½æ›´é«˜ preference: matchExpressions: - key: label-2 operator: In values: - key-2 ç¼–è¾‘å®ŒæˆåæŸ¥çœ‹podï¼Œæ­¤æ—¶podéƒ½è¿è¡Œåœ¨äº†k8snode1èŠ‚ç‚¹ä¸Š 1kubectl -n zy-test get po -o wide ä¿®æ”¹æ ‡ç­¾çš„æƒé‡ 1kubectl -n zy-test edit deploy nginx-deploy 1234567891011121314- weight: 50 preference: matchExpressions: - key: label-1 operator: In values: - key-1- weight: 1 # æƒé‡è¶Šé«˜ï¼Œåç»­è°ƒåˆ°è¿™ä¸ªèŠ‚ç‚¹çš„å¯èƒ½æ›´é«˜ preference: matchExpressions: - key: label-2 operator: In values: - key-2 æŸ¥çœ‹podçŠ¶æ€kubectl -n zy-test get po -o wideï¼Œ æœ€ç»ˆpodéƒ½è¿è¡Œåˆ°äº†masterèŠ‚ç‚¹ä¸Š ä¿®æ”¹æ ‡ç­¾çš„äº²å’Œæ€§ 1kubectl -n zy-test edit deploy nginx-deploy 1234567891011121314- weight: 1 preference: matchExpressions: - key: label-1 operator: NotIn values: - key-1- weight: 50 # æƒé‡è¶Šé«˜ï¼Œåç»­è°ƒåˆ°è¿™ä¸ªèŠ‚ç‚¹çš„å¯èƒ½æ›´é«˜ preference: matchExpressions: - key: label-2 operator: In values: - key-2 æŸ¥çœ‹podçŠ¶æ€kubectl -n zy-test get po -o wideï¼Œæœ€ç»ˆèŠ‚ç‚¹åˆé‡æ–°éƒ¨ç½²åˆ°äº†nodeèŠ‚ç‚¹ä¸Š Podçš„äº²å’ŒåŠ› å‚æ•°è¯´æ˜ 12podAffinity: å°†ä¸æŒ‡å®špodäº²å’ŒåŠ›ç›¸åŒ¹é…çš„podéƒ¨ç½²åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ã€‚podAntiAffinity: æ ¹æ®ç­–ç•¥å°½é‡éƒ¨ç½²æˆ–ä¸éƒ¨ç½²åˆ°ä¸€èµ·ã€‚ ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾ 12kubectl label no k8snode1 topology.kubernetes.io/zone=Vkubectl label no node topology.kubernetes.io/zone=R ç¡®è®¤æ ‡ç­¾ 1kubectl get no --show-labels åˆ›å»ºyml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869---apiVersion: v1kind: Podmetadata: name: with-pod-affinity-s1 namespace: &quot;zy-test&quot; labels: security: S1 topology.kubernetes.io/zone: Rspec: affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: security operator: In values: - S1 topologyKey: topology.kubernetes.io/zone podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: security operator: In values: - S2 topologyKey: topology.kubernetes.io/zone containers: - name: with-pod-affinity image: registry.k8s.io/pause:2.0---apiVersion: v1kind: Podmetadata: name: with-pod-affinity-s2 namespace: &quot;zy-test&quot; labels: security: S2 topology.kubernetes.io/zone: Vspec: affinity: podAffinity: requiredDuringSchedulingIgnoredDuringExecution: - labelSelector: matchExpressions: - key: security operator: In values: - S1 topologyKey: topology.kubernetes.io/zone podAntiAffinity: preferredDuringSchedulingIgnoredDuringExecution: - weight: 100 podAffinityTerm: labelSelector: matchExpressions: - key: security operator: In values: - S2 topologyKey: topology.kubernetes.io/zone containers: - name: with-pod-affinity image: registry.k8s.io/pause:2.0 æŸ¥çœ‹podçŠ¶æ€ï¼Œpodéƒ½è¢«è°ƒåº¦åˆ°äº†k8snode1èŠ‚ç‚¹ä¸Šã€‚ 1kubectl -n zy-test get po -o wide åˆ é™¤pod 1kubectl -n zy-test delete po with-pod-affinity-s1 with-pod-affinity-s2 åˆ é™¤k8snode1èŠ‚ç‚¹ä¸Šçš„æ ‡ç­¾topology.kubernetes.io/zone 1kubectl label no k8snode1 topology.kubernetes.io/zone- é‡æ–°åˆ›å»ºpod 1kubectl create -f affinity-pod.yml podå·²ç»è¢«è°ƒåº¦åˆ°äº†nodeèŠ‚ç‚¹ 1kubectl -n zy-test get po -o wide","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸ƒï¼‰ï¼šinitCåˆå§‹åŒ–å®¹å™¨","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸ƒï¼‰ï¼šinitCåˆå§‹åŒ–å®¹å™¨","date":"2023-07-21T03:18:43.000Z","updated":"2023-07-21T10:57:30.212Z","comments":true,"path":"2023/07/21/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸ƒï¼‰ï¼šinitCåˆå§‹åŒ–å®¹å™¨/","link":"","permalink":"http://jimoblivion.github.io/2023/07/21/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%83%EF%BC%89%EF%BC%9AinitC%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8/","excerpt":"","text":"initC åœ¨çœŸæ­£çš„å®¹å™¨å¯åŠ¨ä¹‹å‰ï¼Œå…ˆå¯åŠ¨initContainerï¼Œå†åˆå§‹åŒ–å®¹å™¨ä¸­å®ŒæˆçœŸå®å®¹å™¨æ‰€éœ€è¦çš„åˆå§‹åŒ–æ“ä½œï¼Œå®Œæˆåå†æ¬¡å¯åŠ¨çœŸå®çš„å®¹å™¨ã€‚ ç›¸å¯¹äºpostStartæ¥è¯´ï¼Œé¦–å…ˆinitContainerèƒ½å¤Ÿä¿è¯ä¸€å®šåœ¨EntryPointä¹‹å‰æ‰§è¡Œï¼Œè€ŒpostStartä¸èƒ½ï¼Œå…¶æ¬¡postStartæ›´é€‚åˆå»æ‰§è¡Œä¸€äº›å‘½ä»¤æ“ä½œï¼Œè€ŒinitControllerå®é™…å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå¯ä»¥åœ¨å…¶ä»–åŸºç¡€å®¹å™¨ç¯å¢ƒä¸‹æ‰§è¡Œæ›´å¤æ‚çš„åˆå§‹åŒ–åŠŸèƒ½ã€‚ æŸ¥çœ‹å½“å‰deploy 1kubectl -n zy-test get deploy ç¼–è¾‘å½“å‰deploy 1kubectl -n zy-test edit deploy nginx-deploy 1234567891011template: metadata: creationTimestamp: null labels: app: nginx-deploy spec: initContainers: - image: nginx:1.7.9 imagePullPolicy: IfNotPresent command: [&quot;sh&quot;, &quot;-c&quot;, &quot;sleep 10; echo &#x27;inited&#x27; &gt;&gt; /.init&quot;] name: init-test æµ‹è¯• ä¿å­˜åæŸ¥çœ‹æˆ‘ä»¬PodçŠ¶æ€ï¼Œå‘ç°æ–°åˆ›å»ºçš„Podçš„STATUSæ—¶init:0&#x2F;1çš„çŠ¶æ€ æŸ¥çœ‹æœ€æ–°çš„å®¹å™¨ 1kubectl -n zy-test get po è¿›å…¥å®¹å™¨å†…éƒ¨ 1kubectl -n zy-test exec -it nginx-deploy-787859bfbd-j2v5p -- sh å¹¶æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬çš„initç›®å½•ï¼ŒåŸå› æ˜¯æ–‡ä»¶éšç€åˆå§‹åŒ–å®¹å™¨ä¸€èµ·è¢«é”€æ¯äº†ã€‚","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"initC","slug":"initC","permalink":"http://jimoblivion.github.io/tags/initC/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…­ï¼‰ï¼šCronJobå®šæ—¶ä»»åŠ¡","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…­ï¼‰ï¼šCronJobå®šæ—¶ä»»åŠ¡","date":"2023-07-21T03:12:42.000Z","updated":"2023-07-21T03:35:40.501Z","comments":true,"path":"2023/07/21/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå…­ï¼‰ï¼šCronJobå®šæ—¶ä»»åŠ¡/","link":"","permalink":"http://jimoblivion.github.io/2023/07/21/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%EF%BC%9ACronJob%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/","excerpt":"","text":"CronJob123åœ¨K8sä¸­å‘¨æœŸæ€§è¿è¡Œè®¡åˆ’ä»»åŠ¡ï¼Œä¸linuxä¸­çš„crontabç›¸åŒæ³¨æ„ï¼šCronJobæ‰§è¡Œçš„äº‹ä»¶æ˜¯controller-managerçš„æ—¶é—´ï¼Œæ‰€ä»¥ä¸€å®šè¦ç¡®ä¿controller-manageræ—¶é—´æ—¶å‡†ç¡®çš„ã€‚ åˆ›å»º åˆ›å»ºyml 123456789101112131415161718192021222324apiVersion: batch/v1kind: CronJobmetadata: name: cron-job-test namespace: &quot;zy-test&quot;spec: concurrencyPolicy: Allow failedJobsHistoryLimit: 1 successfulJobsHistoryLimit: 3 suspend: false schedule: &quot;* * * * *&quot; jobTemplate: spec: template: spec: containers: - name: busybox image: busybox:1.28 imagePullPolicy: IfNotPresent command: - /bin/sh - -c - date; echo Hello from the Kubernetes cluster restartPolicy: OnFailure 1kubectl apply -f cron-job-po.yml ç¨ç­‰ç‰‡åˆ»æŸ¥çœ‹pod 1kubectl -n zy-test get po æŸ¥çœ‹podæ—¥å¿— ç­‰ä¸¤åˆ†é’Ÿåå†æ¬¡æŸ¥çœ‹Pod,Podä¼šç»´æŒ3ä¸ªç„¶åé”€æ¯æœ€è€çš„Podå¹¶ä¸”å¯åŠ¨æ–°çš„Pod","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"CronJob","slug":"CronJob","permalink":"http://jimoblivion.github.io/tags/CronJob/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäº”ï¼‰ï¼šStorageClasså­˜å‚¨ç±»","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäº”ï¼‰ï¼šStorageClasså­˜å‚¨ç±»","date":"2023-07-21T02:23:43.000Z","updated":"2023-07-23T12:19:49.115Z","comments":true,"path":"2023/07/21/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäº”ï¼‰ï¼šStorageClasså­˜å‚¨ç±»/","link":"","permalink":"http://jimoblivion.github.io/2023/07/21/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%EF%BC%9AStorageClass%E5%AD%98%E5%82%A8%E7%B1%BB/","excerpt":"","text":"è¯´æ˜éšç€æˆ‘ä»¬çº¿ä¸Šç¯å¢ƒåº”ç”¨è¶Šæ¥è¶Šå¤šï¼Œpvç”³é¢†è¶Šæ¥è¶Šéº»çƒ¦ï¼Œæ‰€ä»¥ä½¿ç”¨StorageClassæ¥åŠ¨æ€åˆ¶å¤‡PVã€‚ Provisionerï¼šåˆ¶å¤‡å™¨ã€‚æ¯ä¸ªStorageClasséƒ½æœ‰ä¸€ä¸ªåˆ¶å¤‡å™¨ï¼Œç”¨æ¥çº¦å®šä½¿ç”¨å“ªä¸ªå·æ’ä»¶åˆ¶å¤‡PVã€‚ åŠ¨æ€åˆ›å»ºNFS-PVé¦–å…ˆåˆ›å»ºrbacæƒé™ æ–°å»ºyaml 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061apiVersion: v1kind: ServiceAccountmetadata: name: nfs-client-provisioner namespace: kube-system---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata: name: nfs-client-provisioner-runner namespace: kube-systemrules: - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolume&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;delete&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumeclaims&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;update&quot;] - apiGroups: [&quot;storage.k8s.ioi&quot;] # ï¼ï¼æ‹¼å†™é”™è¯¯ï¼Œä¹‹åä¼šè¿›è¡Œé—®é¢˜æ’æŸ¥ resources: [&quot;storageclasses&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;events&quot;] verbs: [&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;]---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata: name: run-nfs-client-provisioner namespace: kube-systemsubjects: - kind: ServiceAccount name: nfs-client-provisioner namespace: &quot;zy-test&quot;roleRef: kind: ClusterRole name: nfs-client-provisioner-runner apiGroup: rbac.authorization.k8s.io---apiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata: name: leader-locking-nfs-client-provisioner namespace: kube-systemrules: - apiGroups: [&quot;&quot;] resources: [&quot;endpoints&quot;] verbs: [&quot;get&quot;,&quot;list&quot;,&quot;watch&quot;,&quot;create&quot;,&quot;update&quot;,&quot;patch&quot;]---apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata: name: leader-locking-nfs-client-provisioner namespace: kube-systemsubjects: - kind: ServiceAccount name: nfs-client-provisionerroleRef: kind: Role name: leader-locking-nfs-client-provisioner apiGroup: rbac.authorization.k8s.io åˆ›å»ºæƒé™ 1kubectl apply -f nfs-provisioner-rbac.yml åˆ›å»ºdeployment 1234567891011121314151617181920212223242526272829303132333435363738apiVersion: apps/v1kind: Deploymentmetadata: name: nfs-client-provisioner namespace: kube-system labels: app: nfs-client-provisionerspec: replicas: 1 strategy: type: Recreate # åœæ­¢æ—§ç‰ˆæœ¬ï¼Œå¯åŠ¨æ–°ç‰ˆæœ¬ selector: matchLabels: app: nfs-client-provisioner template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NEW # åˆ¶å¤‡å™¨çš„åå­— value: fuseim.pri/ifs - name: NFS_SERVER value: 192.168.1.21 - name: NFS_PATH value: /data/nfs/rw volumes: - name: nfs-client-root nfs: server: 192.168.1.21 path: /data/nfs/rw 1kubectl apply -f nfs-provisioner-deployment.yml æŸ¥çœ‹Podå‘ç°å‡ºç°é”™è¯¯ CrashLoopBackOff å¯¹Podè¿›è¡Œæè¿°ï¼Œçœ‹ä¸å‡ºå…·ä½“åŸå›  æŸ¥çœ‹deployment å¯¹deploymentè¿›è¡Œæè¿° 1kubectl -n kube-system describe nfs-client-provisioner MinimumReplicasUnavailableæœ€å°å‰¯æœ¬ä¸å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯é¡¹ç›®çš„é…é¢è¶…å‡ºã€‚ MinimumReplicasUnavailableæ˜¯æŒ‡åœ¨Kubernetesä¸­ï¼Œå½“ä¸€ä¸ªDeploymentçš„ReplicaSetçš„å¯ç”¨å‰¯æœ¬æ•°å°äºæœŸæœ›çš„å‰¯æœ¬æ•°æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚è§£å†³æ–¹æ³•æ˜¯æ£€æŸ¥Podçš„çŠ¶æ€ï¼Œä»¥åŠæ£€æŸ¥Podæ˜¯å¦æœ‰è¶³å¤Ÿçš„èµ„æºã€‚å¦‚æœPodæ²¡æœ‰è¶³å¤Ÿçš„èµ„æºï¼Œå¯ä»¥é€šè¿‡å¢åŠ Podçš„èµ„æºé™åˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æŸ¥çœ‹rsï¼Œå‘ç°å‰¯æœ¬çš„readyæ•°é‡ä¸º0 1kubectl -n kube-system get rs | grep nfs è§£å†³åŠæ³•: å¯åŠ¨æ—¶æ‰§è¡Œå‘½ä»¤tail -f /dev/nullï¼Œé˜²æ­¢å®¹å™¨å´©æºƒ 12345678910template: metadata: labels: app: nfs-client-provisioner spec: serviceAccountName: nfs-client-provisioner containers: - name: nfs-client-provisioner image: quay.io/external_storage/nfs-client-provisioner:latest command: [ &quot;/bin/sh&quot;, &quot;-ce&quot;, &quot;tail -f /dev/null&quot; ] åˆ›å»ºstatefulSet 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950---apiVersion: v1kind: Servicemetadata: name: nginx-sc namespace: &quot;zy-test&quot; labels: app: nginx-scspec: type: NodePort ports: - name: web port: 80 protocol: TCP selector: app: nginx-sc---apiVersion: apps/v1kind: StatefulSetmetadata: name: nginx-sc namespace: &quot;zy-test&quot;spec: replicas: 1 serviceName: &quot;nginx-sc&quot; selector: matchLabels: app: nginx-sc template: metadata: labels: app: nginx-sc spec: containers: - image: nginx:1.7.9 name: nginx-sc imagePullPolicy: IfNotPresent volumeMounts: - mountPath: /usr/share/nginx/html name: nginx-sc-test-pvc volumeClaimTemplates: # ç›´æ¥é…ç½®PVCå’ŒPV - metadata: name: nginx-sc-test-pvc spec: storageClassName: managed-nfs-storage accessModes: - ReadWriteMany # å¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¯»å†™ resources: requests: storage: 2Gi 1kubectl apply -f nfs-sc-demo-statefulset.yml é—®é¢˜æ’æŸ¥é—®é¢˜1 æŸ¥çœ‹podçš„çŠ¶æ€ kubectl -n zy-test get poï¼Œå‘ç°podçš„çŠ¶æ€ä¸€ç›´å¤„äºpending å¯¹podè¿›è¡Œæè¿° 1kubectl -n zy-test describe po nginx-sc-0 1kubectl -n zy-test get pvc æ­¤æ—¶PVCæ˜¯Pendingï¼ŒPVæ²¡æœ‰åˆ›å»º åˆ†æ 12345678910111213141516ç”±äºk8s 1.20ç‰ˆæœ¬ä»¥åå‡ºäºå¯¹æ€§èƒ½ç­‰åŸå› ï¼Œk8sæŠŠSeflLinkè¿™ä¸ªåŠŸèƒ½ç¦ç”¨äº†ã€‚ä¸¤ç§è§£å†³æ–¹æ³•ï¼š 1. ä¿®æ”¹apiserveré…ç½®æ–‡ä»¶ï¼ˆä¸æ¨èï¼‰ éœ€è¦åœ¨/etc/kubernetes/manifests/kube-apiserver.yaml æ·»åŠ å‚æ•°å¢åŠ  --feature-gates=RemoveSelfLink=false 2. ä½¿ç”¨ä¸éœ€è¦SelfLinkçš„Provisioner éœ€è¦å°†é•œåƒåœ°å€æ”¹ä¸ºé˜¿é‡Œäº‘çš„åœ°å€ï¼›å¦å¤–å°†åˆ¶å¤‡å™¨çš„åå­—PROVISIONER_NEWæ”¹ä¸ºROVISIONER_NAME containers: - name: nfs-client-provisioner #image: gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0 image: registry.cn-beijing.aliyuncs.com/xngczl/nfs-subdir-external-provisione:v4.0.0 volumeMounts: - name: nfs-client-root mountPath: /persistentvolumes env: - name: PROVISIONER_NAME ## Provisionerçš„åç§°,ä»¥åè®¾ç½®çš„storageclassè¦å’Œè¿™ä¸ªä¿æŒä¸€è‡´ value: fuseim.pri/ifs æˆ‘ä»¬ä½¿ç”¨æ–¹æ³•2ã€‚å¦‚æœé•œåƒè¿˜æ˜¯æ— æ³•æ‹‰å–ï¼Œè§£å†³åŠæ³•æ˜¯å°†é•œåƒæ‹‰å–åˆ°dockeræœ¬åœ°ä»“åº“ï¼Œå¹¶ä¸”æ‰“æ ‡ç­¾è®©k8så¯ä»¥è¯†åˆ«åˆ°ï¼Œæœ€åè¦è®¾ç½®é•œåƒæ‹‰å–æ–¹å¼ä»æœ¬åœ°è·å–ã€‚ æ£€æŸ¥Podçš„çŠ¶æ€å·²ç»å¯ä»¥æ­£å¸¸è¿è¡Œ åˆ›å»ºStorageClass 123456789apiVersion: storage.k8s.io/v1kind: StorageClassmetadata: name: managed-nfs-storageprovisioner: fuseim.pri/ifsparameters: archiveOnDelete: &quot;false&quot;reclaimPolicy: RetainvolumeBindingMode: Immediate 1kubectl apply -f nfs-sc.yml æŸ¥çœ‹åˆ›å»ºçš„StorageClass 1kubectl -n zy-test get sc åˆ›å»ºStatefulSet 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748---apiVersion: v1kind: Servicemetadata: name: nginx-sc labels: app: nginx-scspec: type: NodePort ports: - name: web port: 80 protocol: TCP selector: app: nginx-sc---apiVersion: apps/v1kind: StatefulSetmetadata: name: nginx-scspec: replicas: 1 serviceName: &quot;nginx-sc&quot; selector: matchLabels: app: nginx-sc template: metadata: labels: app: nginx-sc spec: containers: - image: nginx:1.7.9 name: nginx-sc imagePullPolicy: IfNotPresent volumeMounts: - mountPath: /usr/share/nginx/html name: nginx-sc-test-pvc volumeClaimTemplates: # ç›´æ¥é…ç½®PVCå’ŒPV - metadata: name: nginx-sc-test-pvc spec: storageClassName: managed-nfs-storage accessModes: - ReadWriteMany # å¤šä¸ªèŠ‚ç‚¹åŒæ—¶è¯»å†™ resources: requests: storage: 1Gi 1kubectl apply -f nfs-sc-demo-statefulset.yml é—®é¢˜2 åˆ›å»ºæˆåŠŸåæŸ¥çœ‹PVCçŠ¶æ€ï¼Œå‘ç°PVCå¤„äºpendingçŠ¶æ€ã€‚ 1kubectl -n default get pvc 1kubectl -n default describe pvc nginx-sc-test-pvc-nginx-sc-0 Waiting for a volume to be created, either by external provisioner â€œfuseim.pri&#x2F;ifsâ€ or manually created by system administrator è§£å†³æ–¹æ¡ˆï¼Œä¿®æ”¹rabcæƒé™é…ç½® 12- apiGroups: [&quot;storage.k8s.io&quot;] # ä¿®æ”¹ resources: [&quot;storageclasses&quot;] æˆ–è€…ä½¿ç”¨ä»¥ä¸‹æƒé™è¿›è¡Œæ›¿æ¢ 12345678910111213141516171819202122232425262728apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRole # åˆ›å»ºé›†ç¾¤è§’è‰²metadata: name: nfs-client-provisioner-runner# è§’è‰²æƒé™rules: - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumes&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;persistentvolumeclaims&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;] - apiGroups: [&quot;storage.k8s.io&quot;] resources: [&quot;storageclasses&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;events&quot;] verbs: [&quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;services&quot;] verbs: [&quot;get&quot;] - apiGroups: [&quot;extensions&quot;] resources: [&quot;podsecuritypolicies&quot;] resourceNames: [&quot;nfs-provisioner&quot;] verbs: [&quot;use&quot;] - apiGroups: [&quot;&quot;] resources: [&quot;endpoints&quot;] verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;] æ›´æ–°æƒé™ 1kubectl apply -f nfs-provisioner-rbac.yml é‡å¯æœåŠ¡å³å¯ åˆ é™¤å¤šä½™PV å‘ç°å¤šä½™çš„PV ä½¿ç”¨å‘½ä»¤è¿›è¡Œåˆ é™¤ å‘ç°è¿›ç¨‹å¡æ­»ï¼Œæ— æ³•åˆ é™¤ è§£å†³åŠæ³•ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¼ºåˆ¶åˆ é™¤PV 1kubectl patch pv pvc-c9ddb982-45f7-4ffa-94bd-33da4749e468 -p &#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27; æŸ¥çœ‹PVå·²ç»è¢«æˆåŠŸåˆ é™¤","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"StorageClass","slug":"StorageClass","permalink":"http://jimoblivion.github.io/tags/StorageClass/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå››ï¼‰ï¼šPVå’ŒPVC","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå››ï¼‰ï¼šPVå’ŒPVC","date":"2023-07-20T12:28:39.000Z","updated":"2023-07-21T03:11:21.133Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåå››ï¼‰ï¼šPVå’ŒPVC/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E5%9B%9B%EF%BC%89%EF%BC%9APV%E5%92%8CPVC/","excerpt":"","text":"åŸå›  ç”±äºä¸åŒæœåŠ¡å¯èƒ½ä½¿ç”¨ä¸åŒçš„æŒä¹…åŒ–å®ç°æ–¹æ¡ˆï¼Œä¼šå¯¼è‡´æ··ä¹±ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†ã€‚ æŒä¹…å·ï¼ˆPersistent Volumeï¼‰æ˜¯é›†ç¾¤ä¸­çš„ä¸€å—å­˜å‚¨ï¼Œå¯ä»¥ç”±ç®¡ç†å‘˜æå‰åˆ¶å¤‡ï¼Œæˆ–è€…ä½¿ç”¨Storage Classæ¥åŠ¨æ€åˆ¶å¤‡ã€‚PVæŒä¹…å·å’Œæ™®é€šçš„Volumeä¸€æ ·ï¼Œä¹Ÿæ˜¯ä½¿ç”¨å·æ’ä»¶æ¥å®ç°çš„ï¼Œåªæ˜¯ä»–ä»¬æ‹¥æœ‰ç‹¬ç«‹äºä»»ä½•ä½¿ç”¨PVçš„Podçš„ç”Ÿå‘½å‘¨æœŸã€‚ æŒä¹…å·ç”³é¢†ï¼ˆPersistent Volume Claimï¼‰è¡¨è¾¾ç”¨æˆ·å¯¹å­˜å‚¨çš„è¯·æ±‚ã€‚ä¸Podç±»ä¼¼ï¼ŒPodä¼šæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼Œä½†æ˜¯PVCç”³é¢†ä¼šæ¶ˆè€—PVèµ„æºã€‚ PVå·èƒ½å¤Ÿä»¥ReadWriteOnceã€ReadOnlyManyæˆ–ReadWriteMangæ¨¡å¼ä¹‹ä¸€æ¥æŒ‚è½½ã€‚ æ„å»ºé™æ€æ„å»ºé›†ç¾¤ç®¡ç†å‘˜åˆ›å»ºè‹¥å¹²PVå·ï¼Œè¿™äº›å·å¯¹è±¡å¸¦æœ‰çœŸå®å­˜å‚¨çš„ç»†èŠ‚ä¿¡æ¯ï¼Œå¹¶ä¸”å¯¹é›†ç¾¤ç”¨æˆ·å¯è§ã€‚PVå·å¯¹è±¡å­˜åœ¨äºKubernetes APIä¸­ï¼Œå¯ä¾›æ¶ˆè´¹è€…ä½¿ç”¨ åŠ¨æ€æ„å»ºå¦‚æœè¿›ç¾¤ä¸­å·²ç»æœ‰çš„PVæ— æ³•æ»¡è¶³PVCçš„éœ€æ±‚ï¼Œé‚£ä¹ˆé›†ç¾¤ä¼šæ ¹æ®PVCè‡ªåŠ¨æ„å»ºä¸€ä¸ªPVï¼Œè¯¥æ“ä½œæ˜¯é€šè¿‡StroageClasså®ç°çš„ã€‚æƒ³è¦å®ç°è¿™ä¸ªæ“ä½œï¼Œå‰ææ˜¯PVCå¿…é¡»è®¾ç½®StorageClassï¼Œå¦è€…ä¼šæ— æ³•åŠ¨æ€æ„å»ºè¯¥PVï¼Œå¯ä»¥é€šè¿‡DefaultStorageClassæ¥å®ç°PVçš„æ„å»ºã€‚ ç»‘å®šå½“ç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ªPVCå¯¹è±¡åï¼Œä¸»èŠ‚ç‚¹ä¼šç›‘æµ‹æ–°çš„PVCå¯¹è±¡ï¼Œå¹¶ä¸”å¯»æ‰¾ä¸ä¹‹åŒ¹é…çš„PVå·ï¼Œæ‰¾åˆ°PVå·åå°†äºŒè€…ç»‘å®šåœ¨ä¸€èµ·ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„PVï¼Œåˆ™éœ€è¦çœ‹PVCæ˜¯å¦è®¾ç½®StorageClassæ¥å†³å®šæ˜¯å¦åŠ¨æ€åˆ›å»ºPVï¼Œè‹¥æ²¡æœ‰é…ç½®ï¼ŒPVCå°±ä¼šä¸€ç›´å¤„äºæœªç»‘å®šçš„çŠ¶æ€ï¼Œç›´åˆ°æœ‰ä¸ä¹‹åŒ¹é…çš„PVåæ‰ä¼šç”³é¢†ç»‘å®šå…³ç³»ã€‚ ä½¿ç”¨Podå°†PVCå½“ä½œå­˜å‚¨å·æ¥ä½¿ç”¨ï¼Œé›†ç¾¤ä¼šé€šè¿‡PVCæ‰¾åˆ°ç»‘å®šçš„PVï¼Œ å¹¶ä¸ºPodæŒ‚è½½è¯¥å·ã€‚Podä¸€æ—¦ä½¿ç”¨PVCç»‘å®šPVåï¼Œä¸ºäº†ä¿æŠ¤æ•°æ®ï¼Œé¿å…æ•°ä¸¢å¤±é—®é¢˜ï¼ŒPVå¯¹è±¡ä¼šæ”¶åˆ°ä¿æŠ¤ï¼Œåœ¨ç³»ç»Ÿä¸­æ— æ³•è¢«åˆ é™¤ã€‚ å›æ”¶ç­–ç•¥å½“ç”¨æˆ·ä¸å†ä½¿ç”¨å…¶å­˜å‚¨å·æ—¶ï¼Œä»–ä»¬å¯ä»¥ä»APIä¸­å°†PVCå¯¹è±¡åˆ é™¤ï¼Œä»è€Œå…è®¸è¯¥èµ„æºè¢«å›æ”¶å†åˆ©ç”¨ã€‚PVå¯¹è±¡çš„å›æ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤ï¼Œå½“å…¶è¢«ä»ç”³é¢†ä¸­é‡Šæ”¾æ—¶å¦‚ä½•å¤„ç†è¯¥æ•°æ®å·ã€‚ç›®å‰ï¼Œæ•°æ®å·å¯ä»¥è¢«**Retained(ä¿ç•™)ã€Recycled(å›æ”¶)æˆ–Deleted(åˆ é™¤)**ã€‚ ä¿ç•™12345å›æ”¶ç­–ç•¥Retainä½¿å¾—ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å›æ”¶èµ„æºã€‚å½“PVCå¯¹è±¡åˆ«åˆ é™¤æ—¶ï¼ŒPVå·ä»ç„¶å­˜åœ¨ï¼Œå¯¹åº”çš„æ•°æ®å·è¢«è§†ä¸ºâ€œå·²é‡Šæ”¾â€ã€‚ ç”±äºå·ä¸Šä»ç„¶å­˜ç€å‰ä¸€ç”³é¢†äººçš„æ•°æ®ï¼Œè¯¥å·è¿˜ä¸èƒ½ç”¨äºå…¶ä»–ç”³é¢†ã€‚ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ä¸‹é¢æ­¥éª¤æ¥æ‰‹åŠ¨å›æ”¶è¯¥å·ã€‚a. åˆ é™¤PVå¯¹è±¡ã€‚ä¸ä¹‹ç›¸å…³çš„ã€ä½äºå¤–éƒ¨åŸºç¡€è®¾æ–½çš„å­˜å‚¨èµ„äº§åœ¨PVåˆ é™¤ä¹‹åä»ç„¶å­˜åœ¨ã€‚b. æ ¹æ®æƒ…å†µï¼Œæ‰‹åŠ¨æ¸…é™¤æ‰€æœ‰å…³è”çš„å­˜å‚¨èµ„äº§ä¸Šçš„æ•°æ®c. æ‰‹åŠ¨åˆ é™¤æ‰€å…³è”çš„å­˜å‚¨èµ„äº§ åˆ é™¤123å¯¹äºæ”¯æŒDeleteå›æ”¶ç­–ç•¥çš„å·æ’ä»¶ï¼Œåˆ é™¤åŠ¨ä½œä¼šå°†PVå¯¹è±¡ä»Kubernetesä¸­ç§»é™¤ï¼ŒåŒæ—¶ä¹Ÿä¼šä»å¤–éƒ¨åŸºç¡€è®¾æ–½ä¸­ç§»é™¤æ‰€æ›´æ¢è¿çš„å­˜å‚¨èµ„äº§ã€‚åŠ¨æ€åˆ¶å¤‡çš„å·ä¼šç»§æ‰¿å…¶StorageClassä¸­è®¾ç½®çš„å›æ”¶ç­–ç•¥ï¼Œè¯¥ç­–ç•¥é»˜è®¤ä¸ºDeleteã€‚ç®¡ç†å‘˜éœ€è¦æ ¹æ®ç”¨æˆ·çš„æœŸæœ›æ¥é…ç½®StorageClassï¼š å¦åˆ™PVå·è¢«åˆ›å»ºä¹‹åå¿…é¡»è¦è¢«ç¼–è¾‘æˆ–è€…ä¿®è¡¥ã€‚ å›æ”¶12å›æ”¶ç­–ç•¥Recycleå·²ç»è¢«åºŸå¼ƒã€‚å–è€Œä»£ä¹‹çš„å»ºè®®æ–¹æ¡ˆæ—¶ä½¿ç”¨åŠ¨æ€åˆ¶å¤‡ã€‚å¦‚æœä¸‹å±‚çš„å·æ’ä»¶æ”¯æŒï¼Œå›æ”¶ç­–ç•¥Recycleä¼šåœ¨å·ä¸Šæ‰§è¡Œä¸€äº›åŸºæœ¬çš„æ“¦é™¤ï¼ˆrm -rf /thevolume/*ï¼‰æ“ä½œï¼Œä¹‹åå…è®¸è¯¥å·ç”¨äºæ–°çš„PVCç”³é¢†ã€‚ PVçš„çŠ¶æ€Available: ç©ºé—²ï¼Œæœªè¢«ç»‘å®šBound: å·²ç»è¢«PVCç»‘å®šReleased: PVCè¢«åˆ é™¤ï¼Œèµ„æºå·²å›æ”¶ï¼Œä½†æ˜¯PVæœªè¢«é‡æ–°ä½¿ç”¨Failed: è‡ªåŠ¨å›æ”¶å¤±è´¥ åˆ›å»ºpv 12345678910111213141516171819apiVersion: v1kind: PersistentVolumemetadata:name: pv-001namespace: &quot;zy-test&quot;spec:capacity: storage: 2GivolumeMode: FilesystemaccessModes: - ReadWriteManypersistentVolumeReclaimPolicy: RetainstorageClassName: slowmountOptions: - hard - nfsvers=4.2nfs: path: /data/nfs/rw/test-pv server: 192.168.1.21 åˆ›å»ºå…±äº«ç›®å½• 1mkdir -p /data/nfs/rw/test-pv 1kubectl create -f nfs-pv.yml æŸ¥çœ‹pvå·²ç»è¢«æ„å»ºæˆåŠŸ 1kubectl -n zy-test get pv æ„å»ºPVC 12345678910111213apiVersion: v1kind: PersistentVolumeClaimmetadata:name: nfs-pvcnamespace: &quot;zy-test&quot;spec:accessModes: - ReadWriteMany # æƒé™éœ€è¦å’Œå¯¹åº”çš„pvç›¸åŒvolumeMode: Filesystemresources: requests: storage: 2Gi # èµ„æºè¦å°äºpvçš„storageClassName: slow # åå­—è¦å’Œå¯¹åº”çš„pvç›¸åŒ 1kubectl create -f nfs-pvc.yml æŸ¥çœ‹pvcå·²ç»è¢«æ„å»ºæˆåŠŸï¼Œå¹¶ä¸”æˆåŠŸç»‘å®šåˆ°pv-001 1kubectl -n zy-test get pvc Podç»‘å®šPVCï¼Œåœ¨Podçš„æŒ‚è½½å®¹å™¨é…ç½®ä¸­ï¼Œå¢åŠ PVCæŒ‚è½½ 1234567891011121314151617apiVersion: v1kind: Podmetadata:name: test-pvc-pdnamespace: &quot;zy-test&quot;spec:containers:- image: nginx:1.7.9 imagePullPolicy: IfNotPresent name: nginx-volume volumeMounts: - mountPath: /test-pd # æŒ‚è½½åˆ°å®¹å™¨çš„å“ªä¸ªç›®å½• name: test-volume # æŒ‚è½½åˆ°å“ªä¸ªvolumevolumes:- name: test-volume persistentVolumeClaim: claimName: nfs-pvc # é€šè¿‡nameç»‘å®šåˆ°æŒ‡å®šçš„PVC 1kubectl create -f nginx-pvc-pd.yml æŸ¥çœ‹podä¿¡æ¯ 1kubectl -n zy-test get po -o wide æµ‹è¯• æµ‹è¯•æ–‡ä»¶åŒæ­¥ 123cd /data/nfs/rw/test-pv/echo &quot;success...^_^&quot; &gt; index.htmlcurl 10.244.249.34 æ–‡ä»¶åŒæ­¥æˆåŠŸ","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"pv","slug":"pv","permalink":"http://jimoblivion.github.io/tags/pv/"},{"name":"pvc","slug":"pvc","permalink":"http://jimoblivion.github.io/tags/pvc/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸‰ï¼‰ï¼šNFSæŒ‚è½½","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸‰ï¼‰ï¼šNFSæŒ‚è½½","date":"2023-07-20T12:00:25.000Z","updated":"2023-07-20T12:54:10.243Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸‰ï¼‰ï¼šNFSæŒ‚è½½/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%89%EF%BC%89%EF%BC%9ANFS%E6%8C%82%E8%BD%BD/","excerpt":"","text":"NFSè¯´æ˜nfså·èƒ½å°†NFS(ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ)æŒ‚è½½åˆ°ä½ çš„Podä¸­ã€‚ä¸åƒemptyDiré‚£æ ·ä¼šåˆ é™¤Podçš„åŒæ—¶ä¹Ÿä¼šè¢«åˆ é™¤ã€‚nfså·çš„å†…å®¹åœ¨åˆ é™¤Podæ—¶ä¼šè¢«ä¿å­˜ï¼Œå·åªæ˜¯è¢«å¸è½½ã€‚ è¿™æ„å‘³ç€nfså·å¯ä»¥è¢«é¢„å…ˆå¡«å……æ•°æ®ï¼Œå¹¶ä¸”è¿™äº›æ•°æ®å¯ä»¥åœ¨podä¹‹é—´å…±äº«ã€‚ æ€»ç»“ï¼šNFSå®ç°äº†å®¹å™¨ä¹‹é—´çš„æ•°æ®å…±äº«ï¼Œå¹¶ä¸”å®ç°äº†æŒä¹…åŒ–ï¼Œä½†æ˜¯å› ä¸ºç½‘ç»œIOå’Œç£ç›˜IOç­‰ä¼šå¯¼è‡´æ•ˆç‡æ¯”è¾ƒä½ã€‚ å®‰è£…åœ¨ä½¿ç”¨nfsçš„æœåŠ¡å™¨ä¸Šåˆ†åˆ«å®‰è£…â€¢ å®‰è£…nfs yum install nfs-utils -yâ€¢ å¯åŠ¨nfs systemctl start nfs-serverâ€¢ æŸ¥çœ‹nfsçš„ç‰ˆæœ¬ cat /proc/fs/nfsd/versionsâ€¢ åœ¨k8snode1èŠ‚ç‚¹ä¸Šåˆ›å»ºå…±äº«ç›®å½• mkdir -p /data/nfs cd /data/nfs/ mkdir rw mkdir roâ€¢ è®¾ç½®å…±äº«ç›®å½• export vim /etc/exportsâ€¢ é…ç½®å…±äº«ç›®å½•å’Œç½‘æ®µ /data/nfs/rw 192.168.1.0/24(rw,sync,no_subtree_check,no_root_squash) /data/nfs/ro 192.168.1.0/24(ro,sync,no_subtree_check,no_root_squash)â€¢ é‡æ–°åŠ è½½nfs exportfs -f systemctl reload nfs-serverâ€¢ åˆ°nodeèŠ‚ç‚¹å®‰è£…nfs-utilså¹¶è¿›è¡Œæµ‹è¯• mkdir -p /mnt/nfs/rw mkdir -p /mnt/nfs/ro mount -t nfs 192.168.1.21:/data/nfs/rw /mnt/nfs/rw mount -t nfs 192.168.1.21:/data/nfs/ro /mnt/nfs/ro æµ‹è¯•â€¢ åœ¨nodeèŠ‚ç‚¹å…±äº«è¯»å†™&#x2F;rwç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ cd /mnt/nfs/rw/ touch README.mdâ€¢ æŸ¥çœ‹k8snode1èŠ‚ç‚¹ä¸­å…±äº«ç›®å½•æ–‡ä»¶ï¼Œå‘ç°README.mdæ–‡ä»¶å·²ç»åŒæ­¥æˆåŠŸ cd /data/nfs/rw/â€¢ åœ¨nodeèŠ‚ç‚¹åªè¯»&#x2F;roç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶ cd /mnt/nfs/ro/â€¢ æ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼Œæç¤ºï¼š touch: cannot touch â€˜testâ€™: Read-only file system å®ç°æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ åˆ›å»ºyml 123456789101112131415161718apiVersion: v1kind: Podmetadata: name: nfs-test-pd1 namespace: &quot;zy-test&quot;spec: containers: - image: nginx:1.7.9 name: test-container volumeMounts: - mountPath: /usr/share/nginx/html name: test-volume volumes: - name: test-volume nfs: server: 192.168.1.21 path: /data/nfs/rw/www/share readOnly: false åˆ›å»ºå…±äº«ç›®å½•å’Œæ–‡ä»¶ 12mkdir -p /data/nfs/rw/www/shareecho &#x27;&lt;h1&gt;hello&lt;/h1&gt;&#x27; &gt; /data/nfs/rw/www/share/index.html åˆ›å»ºpod 1kubectl create -f nginx-nfs-po.yml æŸ¥çœ‹podçš„ipï¼Œå¹¶ä¸”è®¿é—® ä¿®æ”¹å…±äº«ç›®å½•ä¸­æ–‡ä»¶å†…å®¹ 1echo &#x27;&lt;h1&gt;success&lt;/h1&gt;&#x27; &gt; /data/nfs/rw/www/share/index.html","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"nfs","slug":"nfs","permalink":"http://jimoblivion.github.io/tags/nfs/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäºŒï¼‰ï¼šæŒä¹…åŒ–å­˜å‚¨","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäºŒï¼‰ï¼šæŒä¹…åŒ–å­˜å‚¨","date":"2023-07-20T10:35:19.000Z","updated":"2023-07-20T12:19:56.060Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåäºŒï¼‰ï¼šæŒä¹…åŒ–å­˜å‚¨/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%BA%8C%EF%BC%89%EF%BC%9A%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8/","excerpt":"","text":"åˆ›å»º åˆ›å»ºyml 1234567891011121314151617apiVersion: v1kind: Podmetadata: name: test-volume-pd namespace: &quot;zy-test&quot;spec: containers: - image: nginx:1.7.9 name: nginx-volume volumeMounts: - mountPath: /test-pd name: test-volume volumes: - name: test-volume hostPath: path: /usr/local/docker/data/ type: DirectoryOrCreate HostPathè¯´æ˜å°†èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æŒ‚è½½åˆ°Podä¸Šï¼Œæ­¤æ—¶è¯¥ç›®å½•ä¼šå˜æˆæŒä¹…åŒ–å­˜å‚¨ç›®å½•ï¼Œå³ä½¿Podè¢«åˆ é™¤åé‡å¯ï¼Œä¹Ÿå¯ä»¥é‡æ–°åŠ è½½åˆ°è¯¥ç›®å½•ï¼Œè¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸ä¼šä¸¢å¤±ã€‚ Type: ç±»å‹ $ç©ºå­—ç¬¦ä¸²$ï¼š é»˜è®¤ç±»å‹ï¼Œä¸åšä»»ä½•æ£€æŸ¥$DirectoryOrCreate$: å¦‚æœç»™å®šçš„pathä¸å­˜åœ¨ï¼Œå°±åˆ›å»ºä¸€ä¸ª755çš„ç©ºç›®å½•$Directory$: è¿™ä¸ªç›®å½•å¿…é¡»å­˜åœ¨$FileOrCreate$: å¦‚æœç»™å®šçš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ï¼Œæƒé™ä¸º644$File$: è¿™ä¸ªæ–‡ä»¶å¿…é¡»å­˜åœ¨$Socket$: UNIX å¥—æ¥å­—ï¼Œå¿…é¡»å­˜åœ¨$CharDevice$: å­—ç¬¦è®¾å¤‡ï¼Œå¿…é¡»å­˜åœ¨$BlockDevice$: å—è®¾å¤‡ï¼Œæ¯”å“¦å¾å­˜åœ¨ æµ‹è¯• è¿›å…¥å®¹å™¨å†…éƒ¨ç›®å½• ï¼Œkubectl -n zy-test exec -it test-volume-pd -- sh ç›®å½•æŒ‚è½½æˆåŠŸï¼Œæˆ‘ä»¬ä»å¤–éƒ¨æ·»åŠ æ–‡ä»¶ touch new.txt å†å®¹å™¨å†…éƒ¨å¯ä»¥æŸ¥çœ‹åˆ°æ–°å¢çš„æ–‡ä»¶ åŒæ ·ï¼Œåœ¨å®¹å™¨å†…éƒ¨æˆ‘ä»¬æ–°å¢æ–‡ä»¶ èŠ‚ç‚¹ä¸Šæ–‡ä»¶ä¹Ÿè¢«åŒæ­¥ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®ç°äº†æ–‡ä»¶çš„å…±äº« EmptyDirè¯´æ˜ä¸»è¦ç”¨äºä¸€ä¸ªPodä¸­ä¸åŒçš„Containerå…±äº«æ•°æ®ä½¿ç”¨çš„ï¼Œç”±äºåªæ˜¯åœ¨Podå†…éƒ¨ä½¿ç”¨ï¼Œå› æ­¤ä¸å…¶ä»–volumeæ¯”è¾ƒå¤§çš„åŒºåˆ«æ˜¯ï¼Œå½“Podå¦‚æœè¢«åˆ é™¤äº†ï¼Œé‚£ä¹ˆemptyDirä¹Ÿä¼šè¢«åˆ é™¤ã€‚ å­˜å‚¨ä»‹è´¨å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œå¯ä»¥å°†emptyDir.mediumè®¾ç½®ä¸ºMemoryè®©k8sä½¿ç”¨tmpfs(å†…å­˜æ”¯æŒæ–‡ä»¶ç³»ç»Ÿ)ï¼Œé€Ÿåº¦æ¯”è¾ƒå—ï¼Œä½†æ˜¯é‡å¯tmpfsèŠ‚ç‚¹æ—¶ï¼Œæ•°æ®ä¼šè¢«æ¸…ç†ï¼Œä¸”è®¾ç½®çš„å¤§å°ä¼šè®¡å…¥åˆ°Containerçš„å†…å­˜é™åˆ¶ä¸­ã€‚ æµ‹è¯• åˆ›å»ºyml 12345678910111213141516171819202122apiVersion: v1kind: Podmetadata: name: empty-dir-pd namespace: &quot;zy-test&quot;spec: containers: - image: alpine name: nginx-emptydir1 command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 3600;&quot;] volumeMounts: - mountPath: /cache name: cache-volume - image: alpine name: nginx-emptydir2 command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;sleep 3600;&quot;] volumeMounts: - mountPath: /opt name: cache-volume volumes: - name: cache-volume emptyDir: &#123;&#125; åˆ›å»ºæˆåŠŸåè¿›å…¥å®¹å™¨nginx-emptydir1å†…éƒ¨ 1kubectl -n zy-test exec -it empty-dir-pd -c nginx-emptydir1 -- sh å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŒ‚è½½çš„ç›®å½•&#x2F;cache æµ‹è¯•åœ¨å…±äº«ç›®å½•åˆ›å»ºæ–‡ä»¶ touch test.txt è¿›å…¥å®¹å™¨nginx-emptydir2å†…éƒ¨ 1kubectl -n zy-test exec -it empty-dir-pd -c nginx-emptydir2 -- sh å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æŒ‚è½½çš„ç›®å½•&#x2F;optï¼Œå¹¶ä¸”æ–‡ä»¶å®ç°äº†åŒæ­¥","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"HostPath","slug":"HostPath","permalink":"http://jimoblivion.github.io/tags/HostPath/"},{"name":"EmptyDir","slug":"EmptyDir","permalink":"http://jimoblivion.github.io/tags/EmptyDir/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šé…ç½®ä¸å­˜å‚¨","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šé…ç½®ä¸å­˜å‚¨","date":"2023-07-20T08:48:34.000Z","updated":"2023-07-20T12:05:46.521Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåä¸€ï¼‰ï¼šé…ç½®ä¸å­˜å‚¨/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%AD%98%E5%82%A8/","excerpt":"","text":"ConfigMapåˆ›å»ºConfigMap åˆ›å»ºæ–‡ä»¶ 1234mkdir test# æ·»åŠ è‡ªå®šä¹‰å±æ€§é…ç½®ï¼švim ./test/db.propertiesvim ./test/redis.properties åˆ›å»ºcm 1kubectl -n zy-test create configmap test-dir-config --from-file=./test/ æŸ¥çœ‹é…ç½®ä¿¡æ¯ 1kubectl -n zy-test describe cm test-dir-config ConfigMapçš„åˆ›å»ºæ–¹å¼ æŒ‡å®šæ–‡ä»¶ï¼Œå¹¶ä¸”è‡ªå®šä¹‰æ–‡ä»¶åæ¥åˆ›å»ºconfigMap 1kubectl -n zy-test create cm test-file-redis-config --from-file=redis.conf=./test/redis.properties æ²¡æœ‰æ–‡ä»¶åçš„æ–¹å¼åˆ›å»ºconfigMap 1kubectl -n zy-test create configmap test-key-value-config --from-literal=username=root --from-literal=passwd=123 æµ‹è¯•ConfigMapä½¿ç”¨ åˆ›å»ºcm 1kubectl -n zy-test create configmap test-env-config --from-literal=JAVA_OPTS_TEST=&#x27;-Xms512m -Xmx512m&#x27; --from-literal=APP_NAME=spring æ–°å»ºymlï¼Œå¹¶ä¸”å¼•ç”¨configMapä¸­çš„é¡¹ 12345678910111213141516171819202122232425262728293031323334apiVersion: v1kind: Podmetadata: name: test-env-cm namespace: zy-testspec: containers: - name: env-test image: alpine command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;env;sleep 3600&quot;] imagePullPolicy: IfNotPresent env: - name: JAVA_VM_OPTS valueFrom: configMapKeyRef: name: test-env-config key: JAVA_OPTS_TEST - name: APP valueFrom: configMapKeyRef: name: test-env-config key: APP_NAME volumeMounts: - name: db-config mountPath: &quot;/usr/local/mysql/conf&quot; readOnly: true volumes: - name: db-config configMap: name: test-dir-config items: - key: &quot;db.properties&quot; path: &quot;db.properties&quot; restartPolicy: Never æŸ¥çœ‹æ—¥å¿— 1kubectl -n zy-test logs -f test-env-cm 1kubectl create -f env-test-pod.yml è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹é…ç½®æŒ‚è½½çš„ç›®å½•çš„é…ç½®æ–‡ä»¶ 1kubectl -n zy-test exec -it test-env-cm -- sh åŠ å¯†æ•°æ®é…ç½® Secretæ³¨æ„ï¼šå¦‚æœè¦åŠ å¯†çš„å­—ç¬¦ä¸­åŒ…å«äº†ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦ä½¿ç”¨è½¬ä¹‰ç¬¦è½¬ä¹‰ï¼Œä¾‹å¦‚$è½¬ä¹‰åä¸º\\\\$ ä¹Ÿå¯ä»¥å¯¹ç‰¹æ®Šå­—ç¬¦ä½¿ç”¨å•å¼•å·æè¿°ï¼Œè¿™æ ·å°±ä¸éœ€è¦è½¬ä¹‰ä¾‹å¦‚1$289*!è½¬æ¢ä¸º&#39;1$289*!&#39; æ•°æ®åŠ å¯† 1kubectl -n zy-test create secret docker-registry harbor-secret --docker-username=admin --docker-password=admin --docker-email=sam@qq.com æŸ¥çœ‹å¯†é’¥ 1kubectl -n zy-test edit secret harbor-secret ä½¿ç”¨base64è¿›è¡Œè§£å¯†ï¼Œå¯ä»¥çœ‹åˆ°åˆå§‹å€¼ 1echo &#x27;eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoiYWRtaW4iLCJlbWFpbCI6InNhbUBxcS5jb20iLCJhdXRoIjoiWVdSdGFXNDZZV1J0YVc0PSJ9fX0=&#x27; | base64 --decode SubPathçš„ä½¿ç”¨ä½¿ç”¨SubPathçš„åŸå›  æŸ¥çœ‹å®¹å™¨ kubectl -n zy-test get po è¿›å…¥å®¹å™¨ kubectl -n zy-test exec -it nginx-deploy-7b49587448-vqb7l -- sh æ‰¾åˆ°å®¹å™¨ä¸­æ–‡ä»¶/etc/nginx/conf.d/nginx.conf æ‹·è´å†…å®¹ï¼Œæ–°å»ºæ–‡ä»¶åˆ°æˆ‘ä»¬çš„ç›®å½•ä¸­nginx.confæ–‡ä»¶ä¸­ åˆ›å»ºconfigMap kubectl -n zy-test create configmap nginx-conf-cm --from-file=./nginx.conf ç¼–è¾‘deployï¼Œæ–°å¢æ•°æ®å· kubectl -n zy-test edit deploy nginx-deploy 123456789101112131415161718192021spec: template: spec: containers: - image: nginx:1.7.9 imagePullPolicy: IfNotPresent name: nginx -- terminationMessagePath: /dev/termination-log terminationMessagePolicy: File volumeMounts: - name: nginx-conf # æ•°æ®å·çš„åç§° mountPath: &#x27;/etc/nginx&#x27; # å¸Œæœ›æŠŠæ–‡ä»¶åŠ è½½åˆ°å®¹å™¨ä¸­çš„ç›®å½• volumes: - name: nginx-conf configMap: name: nginx-conf-cm # configmapçš„name items: - key: nginx.conf path: nginx.conf dnsPolicy: ClusterFirst æŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼Œå‘ç°æŠ¥é”™ kubectl -n zy-test get po æè¿°å®¹å™¨ä¸­çš„é”™è¯¯å†…å®¹ kubectl -n zy-test describe po nginx-deploy-76459d6d66-fxmsg è¿›å…¥å®¹å™¨æŸ¥çœ‹æ–‡ä»¶æ˜¯å¦åŠ è½½ï¼Œå‘ç°æŠ¥é”™ï¼ŒåŸå› æ˜¯æˆ‘ä»¬å®¹å™¨æœªå¯åŠ¨æˆåŠŸã€‚è§£å†³åŠæ³•: ç»™å®¹å™¨åŠ ä¸€ä¸ªç¡çœ æ—¶é—´ï¼Œè®©ä»–ä¸è¦æŒ‚æ‰ã€‚ ç¼–è¾‘deployment kubectl -n zy-test edit deploy nginx-deploy 123456spec: containers: - image: nginx:1.7.9 imagePullPolicy: IfNotPresent name: nginx command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;nginx daemon off;sleep 3600&quot;] æŸ¥çœ‹å½“å‰pod è¿›å…¥å®¹å™¨ kubectl -n zy-test exec -it nginx-deploy-5f986958cc-fh8wf -- bash å‘ç°å®¹å™¨ç›®å½•ä¸­å…¶ä»–æ–‡ä»¶éƒ½æ²¡æœ‰äº†ï¼Œåªå‰©ä¸‹nginx.confã€‚åŸå› æ˜¯ä½¿ç”¨ConfigMapæˆ–SecretæŒ‚è½½åˆ°ç›®å½•çš„æ—¶å€™ï¼Œä¼šå°†å®¹å™¨ä¸­æºç›®å½•è¦†ç›–æ‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯èƒ½åªæƒ³è¦†ç›–ç›®å½•ä¸­æŸä¸€ä¸ªæ–‡ä»¶ï¼Œ æ‰€ä»¥è¦ä½¿ç”¨subpathã€‚ ä½¿ç”¨SubPath ç¼–è¾‘deploy, &#x3D;&#x3D;#1&#x3D;&#x3D; å’Œ &#x3D;&#x3D;#2&#x3D;&#x3D;çš„è·¯å¾„è¦ä¿æŒä¸€è‡´ 1kubectl -n zy-test edit deploy nginx-deploy 1234567891011121314---- volumes: - configMap: defaultMode: 420 items: - key: nginx.conf path: etc/nginx/nginx.conf # 1 name: nginx-conf-cm name: nginx-conf--- volumeMounts: - mountPath: /etc/nginx/nginx.conf name: nginx-conf subPath: etc/nginx/nginx.conf #2 æŸ¥çœ‹podçš„è¿è¡ŒçŠ¶æ€ 1kubectl -n zy-test get po è¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œæ–‡ä»¶æ­£å¸¸ 1kubectl -n zy-test edit deploy nginx-deploy ConfigMapçƒ­æ›´æ–° å¦‚æœæ›´æ–°configmapä¸­çš„é…ç½®ï¼Œä¼šä¸ä¼šæ›´æ–°åˆ°podä¸­å‘¢ï¼Ÿ 1234567é»˜è®¤æ–¹å¼ï¼šä¼šæ›´æ–°ï¼Œæ›´æ–°å‘¨æœŸæ˜¯æ›´æ–°æ—¶é—´ + ç¼“å­˜æ—¶é—´subPath: ä¸ä¼šæ›´æ–°å˜é‡å½¢å¼ï¼šå¦‚æœpodä¸­ä¸€ä¸ªå˜é‡æ˜¯ä»configmapæˆ–secretä¸­å¾—åˆ°çš„ï¼ŒåŒæ ·ä¸ä¼šæ›´æ–°å¯¹äºsubPathçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å–æ¶ˆsubPathçš„ä½¿ç”¨ï¼Œå°†é…ç½®æ–‡ä»¶æŒ‚è½½åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„ç›®å½•ï¼Œé¿å…ç›®å½•çš„è¦†ç›–ï¼Œç„¶åå†åˆ©ç”¨è½¯è¿æ¥çš„å½¢å¼ï¼Œå°†è¯¥æ–‡ä»¶é“¾æ¥åˆ°ç›®æ ‡ä½ç½®ã€‚ä½†æ˜¯å¦‚æœç›®æ ‡ä½ç½®åŸæœ¬å°±æœ‰æ–‡ä»¶ï¼Œå¯èƒ½æ— æ³•åˆ›å»ºè½¯è¿æ¥ï¼Œæ­¤æ—¶å¯ä»¥åŸºäºpostStartæ“ä½œæ‰§è¡Œåˆ é™¤å‘½ä»¤ï¼Œå°†é»˜è®¤çš„æ–‡ä»¶åˆ é™¤å³å¯ã€‚ ä¿®æ”¹cm 1kubectl -n zy-test edit cm test-dir-config è¿›å…¥å®¹å™¨å†…éƒ¨æŸ¥çœ‹é…ç½®å·²ç»å˜æ›´ 1kubectl -n zy-test exec -it test-env-cm -- sh ä½¿ç”¨replaceæ›¿æ¢ï¼Œç»“åˆ--dry-runå‚æ•°ã€‚è¯¥å‚æ•°çš„æ„æ€æ˜¯æ‰“å°yamlæ–‡ä»¶ï¼Œä½†æ˜¯ä¸ä¼šå°†æ–‡ä»¶å‘é€ç»™apiServerï¼Œç»“åˆ-oyamlè¾“å‡ºyamlæ–‡ä»¶å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªé…ç½®å¥½ä½†æ˜¯æ²¡æœ‰å‘ç»™apiserverçš„æ–‡ä»¶ï¼Œç„¶åå†ç»“åˆreplaceç›‘å¬æ§åˆ¶å°è¾“å‡ºå¾—åˆ°yamlæ•°æ®å³å¯å®ç°æ›¿æ¢ã€‚ æŸ¥çœ‹ç¡®è®¤å½“å‰é…ç½® 1kubectl -n zy-test create cm test-dir-config --from-file=./test/ --dry-run=client -o yaml æŠŠå‰ç½®ä½œä¸ºè¾“å…¥ 1kubectl -n zy-test create cm test-dir-config --from-file=./test/ --dry-run=client -o yaml | kubectl replace -f- æ‰§è¡Œå®Œæˆä¹‹åå‘ç°é…ç½®å·²ç»è¢«æ›¿æ¢ä¸ºæ–°çš„ ä¸å¯å˜é…ç½®å¯¹äºä¸€äº›æ•æ„ŸæœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨çº¿ä¸Šæœ‰æ—¶æ˜¯ä¸å…è®¸ä¿®æ”¹çš„ï¼Œæ­¤æ—¶åªéœ€è¦å†é…ç½®configMapçš„æ—¶å€™è®¾ç½®immutable:trueå³å¯ ç¼–è¾‘configMapï¼Œ æ‰“å¼€é…ç½®é¡¹ 1kubectl -n zy-test edit cm test-dir-config 123456789apiVersion: v1data: db.properties: | username=root passwd=123 redis.properties: | ip=127.0.0.1 port=6379immutable: true å†æ¬¡ç¼–è¾‘é…ç½®é¡¹ï¼Œä¿®æ”¹å±æ€§å€¼ï¼Œæ­¤æ—¶å·²ç»ä¸å…è®¸ä¿®æ”¹ 1kubectl -n zy-test edit cm test-dir-config","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"ConfigMap","slug":"ConfigMap","permalink":"http://jimoblivion.github.io/tags/ConfigMap/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåï¼‰ï¼šIngress","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåï¼‰ï¼šIngress","date":"2023-07-20T03:33:26.000Z","updated":"2023-07-20T11:03:07.423Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆåï¼‰ï¼šIngress/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%8D%81%EF%BC%89%EF%BC%9AIngress/","excerpt":"","text":"å®‰è£…é¦–å…ˆå®‰è£…helmâ—‹ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gzâ—‹ è§£å‹tar -zxvf helm-v3.12.0-linux-amd64.tar.gzâ—‹ ç§»åŠ¨åˆ°ç›®å½• mv ./linux-amd64/helm /usr/local/bin/helmâ—‹ æµ‹è¯•helm version â—‹ æ·»åŠ ä»“åº“ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginxâ—‹ æŸ¥çœ‹ä»“åº“åˆ—è¡¨ helm repo list é…ç½®ingressâ—‹ æœç´¢ingress-nginx: helm search repo ingress-nginx â—‹ ä¸‹è½½å®‰è£…åŒ… helm pull ingress-nginx/ingress-nginxâ—‹ å°†ä¸‹è½½å¥½çš„å®‰è£…åŒ…è§£å‹ tar xf ingress-nginx-4.7.1.tgzâ—‹ ä¿®æ”¹é…ç½® vim ./ingress-nginx/values.yaml 12345678910111213controller: name: controller image: ## Keep false as default for now! chroot: false registry: registry.cn-hangzhou.aliyuncs.com # ä¿®æ”¹ image: google_containers/nginx-ingress-controller # ä¿®æ”¹ ## for backwards compatibility consider setting the full image url via the repository value below ## use *either* current default registry/image or repository format or installing chart by providing the values.yaml will fail ## repository: tag: &quot;v1.8.1&quot;# digest: sha256:e5c4824e7375fcf2a393e1c03c293b69759af37a9ca6abdb91b13d78a93da8bd # ä¿®æ”¹# digestChroot: sha256:e0d4121e3c5e39de9122e55e331a32d5ebf8d4d257227cb93ab54a1b912a7627 # ä¿®æ”¹ 1234567891011 patch: enabled: true image: registry: registry.cn-hangzhou.aliyuncs.com # ä¿®æ”¹ image: google_containers/kube-webhook-controller # ä¿®æ”¹ ## for backwards compatibility consider setting the full image url via the repository value below ## use *either* current default registry/image or repository format or installing chart by providing the values.yaml will fail ## repository: tag: v1.8.1# digest: sha256:543c40fd093964bc9ab509d3e791f9989963021f1e9e4c9c7b6700b02bfb227b # ä¿®æ”¹ pullPolicy: IfNotPresent 1234567## Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/##nodeSelector: kubernetes.io/os: linux ingress: &quot;true&quot; # ä¿®æ”¹ å¢åŠ é€‰æ‹©å™¨ï¼Œå¦‚æœnodeä¸Šæœ‰ingress=trueå°±éƒ¨ç½² ## Liveness and readiness probe values## Ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes 123# is mergedhostNetwork: true # ä¿®æ”¹## Use host ports 80 and 443 123 # to keep resolving names inside the k8s network, use ClusterFirstWithHostNet.# dnsPolicy: ClusterFirst # ä¿®æ”¹ dnsPolicy: ClusterFirstWithHostNet # ä¿®æ”¹ 12345678910ipFamilies: - IPv4ports: http: 80 https: 443targetPorts: http: http https: https#type: LoadBalancer # ä¿®æ”¹ å¦‚æœæœåŠ¡æ˜¯äº‘å¹³å°æ‰ç”¨LoadBalancer type: ClusterIP # ä¿®æ”¹ 123456789admissionWebhooks: annotations: &#123;&#125; # ignore-check.kube-linter.io/no-read-only-rootfs: &quot;This deployment needs write access to root filesystem&quot;. ## Additional annotations to the admission webhooks. ## These annotations will be added to the ValidatingWebhookConfiguration and ## the Jobs Spec of the admission webhooks. enabled: false # ä¿®æ”¹ # -- Additional environment variables to set 12# -- Use a `DaemonSet` or `Deployment` kind: DaemonSet # ä¿®æ”¹éƒ¨ç½²é…ç½® â—‹ ä¸ºingressä¸“é—¨åˆ›å»ºå‘½åç©ºé—´ kubectl create ns ingress-nginx å®‰è£…ingressâ—‹ å®‰è£… helm install ingress-nginx -n ingress-nginx ./ingress-nginx â—‹ ä¸ºéœ€è¦éƒ¨ç½²ingressçš„èŠ‚ç‚¹åŠ ä¸Šæ ‡ç­¾ï¼ˆè®© Pod è°ƒåº¦åˆ°æŒ‡å®šçš„èŠ‚ç‚¹ï¼‰kubectl label node k8snode1 ingress=true â—‹ æŸ¥çœ‹èŠ‚ç‚¹ kubectl get node --show-labels â—‹ å¯ä»¥çœ‹åˆ°ingress-nginx éƒ¨ç½²åˆ°äº†nodeèŠ‚ç‚¹äº† kubectl get all -n ingress-nginx æµ‹è¯• åˆ›å»ºyml 123456789101112131415161718apiVersion: networking.k8s.io/v1kind: Ingressmetadata: name: zy-nginx-ingress annotations: kubernetes.io/ingress.class: &quot;nginx&quot;spec: rules: - host: k8s.zy.cn http: paths: - pathType: Prefix backend: service: name: nginx-svc port: number: 80 path: /api æŸ¥çœ‹åˆ›å»ºçš„ingress 1kubectl -o wide get ingress ç»™ä¸»æœºé…ç½®åŸŸå 1echo &quot;192.168.1.21 k8s.zy.cn&quot; &gt;&gt; /etc/hosts æè¿°ingress 1kubectl describe ingress zy-nginx-ingress æ¨æµ‹åŸå› æ˜¯ä¸åŒnamespaceå¯¼è‡´ åˆ é™¤ingress 1kubectl delete -f nginx-ig.yml ä¿®æ”¹å‘½åç©ºé—´ï¼š â—‹ é‡æ–°åˆ›å»º kubectl create -f nginx-ig.yml â—‹ ç¡®è®¤åˆ›å»ºæˆåŠŸ é…ç½®æœ¬åœ°æœºå™¨ â—‹ ç¼–è¾‘æœ¬åœ°ä¸»æœºhostæ–‡ä»¶ C:\\Windows\\System32\\drivers\\etc\\hosts â—‹ æ–°å¢ 192.168.1.21 k8s.zy.cn â—‹ å¯åŠ¨podï¼Œå‘ç°è¿”å›404é”™è¯¯ â—‹ ç¼–è¾‘ ingress ä¿®æ”¹é…ç½®é¡¹ï¼š kubectl -n zy-test edit ingress 1234567kind: Ingressmetadata: name: zy-nginx-ingress namespace: &quot;zy-test&quot; annotations: kubernetes.io/ingress.class: &quot;nginx&quot; nginx.ingress.kubernetes.io/rewrite-target: / # æ–°å¢é…ç½®é¡¹ï¼Œè¿›è¡Œé‡å®šå‘ è®¿é—®è·¯å¾„ http://k8s.zy.cn/api ä¼šè‡ªåŠ¨é‡å®šå‘åˆ° é¦–é¡µ","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"Ingress","slug":"Ingress","permalink":"http://jimoblivion.github.io/tags/Ingress/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¹ï¼‰ï¼šServiceæœåŠ¡å‘ç°","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¹ï¼‰ï¼šServiceæœåŠ¡å‘ç°","date":"2023-07-20T02:22:27.000Z","updated":"2023-07-20T12:06:30.821Z","comments":true,"path":"2023/07/20/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¹ï¼‰ï¼šServiceæœåŠ¡å‘ç°/","link":"","permalink":"http://jimoblivion.github.io/2023/07/20/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B9%9D%EF%BC%89%EF%BC%9AService%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/","excerpt":"","text":"å®¹å™¨ä¹‹é—´é€šè®¯é€šè¿‡svcç»“åˆkube-proxyå¯ä»¥å®ç°å„ä¸ªå®¹å™¨ä¹‹é—´äº’é€šã€‚ åˆ›å»ºyml 123456789101112131415apiVersion: v1kind: Servicemetadata: name: nginx-svc labels: app: nginx namespace: &quot;zy-test&quot;spec: selector: app: nginx-deploy ports: - port: 80 targetPort: 80 name: web type: NodePort åˆ›å»ºsvc 1kubectl create -f nginx-svc.yml æ­¤æ—¶æˆ‘ä»¬å·²ç»åˆ›å»ºäº†labelæ˜¯nginx-deployçš„pod 1kubectl -n zy-test get po -o wide svcåˆ›å»ºå¥½ä»¥åï¼Œä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬åˆ›å»ºendpoints è¿è¡Œä¸€ä¸ªæ–°çš„å®¹å™¨ 1kubectl run -it --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh å®¹å™¨ä¹‹é—´è®¿é—®ä¸é€šé—®é¢˜æ’æŸ¥ è®¿é—®è¢«æ‹’ç»ï¼Œ æŸ¥çœ‹å½“å‰kube-proxyå¤„äºå“ªç§æ¨¡å¼ 1kubectl get cm kube-proxy -n kube-system -o yaml | grep mode modeä¸ºç©ºï¼Œé»˜è®¤ä½¿ç”¨iptableçš„æ¨¡å¼ æŸ¥çœ‹kube-proxyçš„æ—¥å¿— 1docker ps | grep kube-proxy 1docker logs -f k8s_kube-proxy_kube-proxy-2k4tp_kube-system_78f24673-c269-48b9-9874-705cc5acf491_12 E0713 02:34:44.047737 1 proxier.go:1600] â€œcanâ€™t open port, skipping itâ€ err&#x3D;â€listen tcp4 :30082: bind: address already in useâ€ port&#x3D;{Descripeb IP: IPFamily:4 Port:30082 Protocol:TCP} æ¨æµ‹å¯èƒ½æ˜¯å› ä¸ºiptablesæœªå®‰è£…æˆ–å¯ç”¨å¯¼è‡´ï¼Œå°è¯•ä½¿ç”¨ipvsã€‚ è¯¦æƒ…è§ Kube Proxy: Unable to open port when scheduling pods to kube master Â· Issue #107297 Â· kubernetes&#x2F;kubernetes (github.com) å®‰è£…ipvs 1yum install ipvsadm ä¿®æ”¹modeä¸ºipvs 1kubectl edit cm kube-proxy -n kube-system 12# ä¿®æ”¹mode: &quot;ipvs&quot; é‡å¯kube-proxy 1docker restart k8s_kube-proxy_kube-proxy-2k4tp_kube-system_78f24673-c269-48b9-9874-705cc5acf491_12 æŸ¥çœ‹kube-proxyæ—¥å¿— 1docker logs -f k8s_kube-proxy_kube-proxy-2k4tp_kube-system_78f24673-c269-48b9-9874-705cc5acf491_12 å‡ºç°æŠ¥é”™ E0713 02:51:35.448648 1 proxier.go:379] â€œCanâ€™t set sysctl, kernel version doesnâ€™t satisfy minimum version requirementsâ€ sysctl&#x3D;â€net&#x2F;ipv4&#x2F;vs&#x2F;conn_reuse_modeâ€ minimumKernelVersion&#x3D;â€4.1â€ I0713 02:51:35.448815 1 proxier.go:438] â€œIPVS scheduler not specified, use rr by defaultâ€ æ ¹æ®æè¿°ï¼ŒæŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ 1uname -r æ­¤æ—¶éœ€è¦å¯¹å†…æ ¸è¿›è¡Œå‡çº§ï¼Œæ¥å…¼å®¹ipvs å‚è€ƒ CentOS 7 å‡çº§ Linux å†…æ ¸-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com) å®‰è£…å®ŒæˆåæŸ¥çœ‹ç«¯å£è½¬å‘è§„åˆ™ 1ipvsadm -Ln | grep 32023 -A2 32023è½¬å‘è§„åˆ™ä¸‹æœ‰ä¸¤ä¸ª æŸ¥çœ‹podå’Œipèƒ½å¯¹åº”ä¸Š è®¿é—®svcå’Œå¯¹å¤–çš„ç«¯å£ 1curl 192.168.1.20:32023 ä½†æ˜¯è¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œæ‰§è¡Œ nslookup nginx-svc ä¸èƒ½è·å–åˆ°æ­£ç¡®çš„åŸŸåå’Œipã€‚æ¨æµ‹å½“å‰å®¹å™¨æ‰€åœ¨çš„namespaceå’Œæˆ‘è®¿é—®çš„svcæ‰€åœ¨namespaceä¸ä¸€è‡´ã€‚ é€€å‡ºå®¹å™¨ï¼Œåœ¨zy-testçš„å‘½åç©ºé—´å†…åˆ›å»ºbusybox 1kubectl -n zy-test run -it --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh æ­¤æ—¶è®¿é—®nginx-svcæˆåŠŸï¼Œè¯´æ˜å®¹å™¨å†…éƒ¨ä¹‹å‰äº’ç›¸é€šè®¯éœ€è¦åœ¨åŒä¸€å‘½åç©ºé—´ä¸‹ã€‚ å®ç°è®¿é—®å¤–éƒ¨æœåŠ¡123å®ç°æ–¹å¼ï¼š â€¢ ç¼–å†™serviceé…ç½®æ–‡ä»¶æ—¶ï¼Œä¸æŒ‡å®šselectorå±æ€§ â€¢ è‡ªå·±åˆ›å»ºendpoint yamlæ ¼å¼ 123456789101112131415161718192021222324252627282930---apiVersion: v1kind: Servicemetadata: name: nginx-svc-ext labels: app: nginx namespace: &quot;zy-test&quot;spec: ports: - protocol: TCP port: 80 targetPort: 80 name: web type: ClusterIP---apiVersion: v1kind: Endpointsmetadata: labels: app: nginx name: nginx-svc-ext namespace: &quot;zy-test&quot;subsets:- addresses: - ip: xxx.xx.xx.xx # å¤–éƒ¨ip ports: - name: web port: 80 protocol: TCP ä»£ç†å¤–éƒ¨åŸŸå Service å®šä¹‰å°† zy-test åç§°ç©ºé—´ä¸­çš„ nginx-svc-ext æœåŠ¡æ˜ å°„åˆ°www.baidu.com 12345678910apiVersion: v1kind: Servicemetadata: labels: app: nginx name: nginx-svc-ext namespace: &quot;zy-test&quot;spec: type: ExternalName externalName: www.baidu.com æ­¤å¤„typeçš„å¸¸ç”¨ç±»å‹ ClusterIP: åªèƒ½åœ¨é›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼Œä¸èƒ½é…ç½®ç±»å‹çš„è¯é»˜è®¤å°±æ˜¯ClusterIP ExternalName: è¿”å›å®šä¹‰çš„CNAMEåˆ«åï¼Œå¯ä»¥é…ç½®ä¸ºåŸŸå NodePort: ä¼šåœ¨æ‰€æœ‰å®‰è£…äº†kube-proxyçš„èŠ‚ç‚¹ç»‘å®šä¸€ä¸ªç«¯å£ï¼Œæ­¤ç«¯å£å¯ä»¥ä»£ç†è‡³å¯¹åº”çš„Pod, é›†ç¾¤å¤–éƒ¨å¯ä»¥ä½¿ç”¨ä»»æ„èŠ‚ç‚¹IP + NodePortçš„ç«¯å£å·è®¿é—®é›†ç¾¤ä¸­å¯¹åº”Podçš„æœåŠ¡ã€‚ å½“ç±»å‹è®¾ç½®ä¸ºNodePortåï¼Œå¯ä»¥åœ¨Portsé…ç½®ä¸­å¢åŠ NodePorté…ç½®æŒ‡å®šç«¯å£ï¼Œéœ€è¦åœ¨ä¸‹æ–¹ç«¯å£èŒƒå›´å†…ï¼Œå¦‚æœä¸èƒ½æŒ‡å®šä¼šéšæœºæŒ‡å®šç«¯å£ã€‚ ç«¯å£èŒƒå›´ï¼š30000~32767 ç«¯å£èŒƒå›´åœ¨é…ç½®åœ¨ /usr/lib/systemd/system/kube-apiserver.service æ–‡ä»¶ä¸­ LoadBalance: ä½¿ç”¨äº‘æœåŠ¡å•†æä¾›è´Ÿè½½å‡è¡¡æœåŠ¡","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"Service","slug":"Service","permalink":"http://jimoblivion.github.io/tags/Service/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…«ï¼‰ï¼šHPAæ°´å¹³æ‰©å®¹","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…«ï¼‰ï¼šHPAæ°´å¹³æ‰©å®¹","date":"2023-07-19T13:10:35.000Z","updated":"2023-07-20T03:27:10.578Z","comments":true,"path":"2023/07/19/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…«ï¼‰ï¼šHPAæ°´å¹³æ‰©å®¹/","link":"","permalink":"http://jimoblivion.github.io/2023/07/19/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AB%EF%BC%89%EF%BC%9AHPA%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%AE%B9/","excerpt":"","text":"Podè‡ªåŠ¨æ‰©å®¹ å¯ä»¥æ ¹æ®cpuä½¿ç”¨ç‡æˆ–è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆmetricsï¼‰è‡ªåŠ¨å¯¹podè¿›è¡Œæ‰©å®¹&#x2F;ç¼©å®¹ã€‚ 1234567â€¢ æ§åˆ¶ç®¡ç†å™¨æ¯éš”30s( å¯ä»¥é€šè¿‡-horizontal-pod-autosacaler-sync-periodä¿®æ”¹)æŸ¥è¯¢metricsçš„èµ„æºä½¿ç”¨æƒ…å†µâ€¢ æ”¯æŒä¸‰ç§metricsç±»å‹ â—‹ é¢„å®šä¹‰metrics(æ¯”å¦‚Podçš„cpu)ä»¥åˆ©ç”¨ç‡çš„æ–¹å¼è®¡ç®— â—‹ è‡ªå®šä¹‰çš„Pod metricsï¼Œä»¥åŸå§‹å€¼ï¼ˆraw valueï¼‰çš„æ–¹å¼è®¡ç®— â—‹ è‡ªå®šä¹‰çš„object metricsâ€¢ æ”¯æŒä¸¤ç§meticsæŸ¥è¯¢æ–¹å¼ï¼šHeapsterå’Œè‡ªå®šä¹‰çš„REST APIâ€¢ æ”¯æŒå¤šmetricsæŸ¥è¯¢æ–¹å¼ Horizontal Pod AutoScalerï¼ˆHPAï¼‰è‡ªåŠ¨æ‰©å®¹å’Œç¼©å®¹ 123â€¢ é€šè¿‡è§‚å¯Ÿpodçš„cpuã€å†…å­˜ä½¿ç”¨æƒ…å†µæˆ–è‡ªå®šä¹‰metricsæŒ‡æ ‡è¿›è¡Œè‡ªåŠ¨çš„æ‰©å®¹æˆ–è€…ç¼©å®¹podçš„æ•°é‡ã€‚â€¢ é€šå¸¸ç”¨äºDeploymentï¼Œ ä¸é€‚ç”¨äºæ— æ³•æ‰©å®¹/ç¼©å®¹çš„å¯¹è±¡ï¼Œæ¯”å¦‚DaemonSetã€‚â€¢ æ§åˆ¶ç®¡ç†å™¨æ¯éš”30sæŸ¥è¯¢ä¸€æ¬¡metircsçš„èµ„æºä½¿ç”¨æƒ…å†µ åˆ›å»ºèµ„æº1vim nginx-deploy.yml 1234567891011121314151617181920212223242526272829303132apiVersion: apps/v1kind: Deploymentmetadata: name: nginx-deploy labels: app: nginx-deploy test: 1.1.0 namespace: &#x27;zy-test&#x27;spec: replicas: 1 revisionHistoryLimit: 10 selector: matchLabels: app: nginx-deploy template: metadata: labels: app: nginx-deploy spec: terminationGracePeriodSeconds: 15 containers: - name: nginx image: nginx:1.7.9 imagePullPolicy: IfNotPresent resources: requests: cpu: 10m memory: 128Mi limits: cpu: 200m memory: 256Mi restartPolicy: Always cpuã€å†…å­˜æŒ‡æ ‡çš„ç›‘æ§ è®¾ç½®æŒ‡æ ‡ 1kubectl -n zy-test autoscale deploy nginx-deploy --cpu-percent=20 --min=2 --max=5 1234è¯´æ˜ï¼š--cpu-percentæŒ‡çš„æ˜¯cpuçš„ç™¾åˆ†æ¯”è¾¾åˆ°å°±è¿›è¡Œæ‰©å®¹--minæ‰©å®¹ä»¥åæœ€å°çš„å®ä¾‹æ•°æ˜¯2ä¸ª--maxæ‰©å®¹ä»¥åæœ€å¤§çš„å®ä¾‹æ•°æ˜¯5ä¸ª æŸ¥çœ‹deploymentçš„çŠ¶æ€ï¼Œå‘ç°å·²ç»å¸®æˆ‘ä»¬æ‰©å®¹åˆ°2ä¸ªreplicas 1kubectl -n zy-test get deploy ç›‘æ§èµ„æºçš„å ç”¨ 1kubectl -n zy-test top pod nginx-deploy-57d84f45f8-mrtqk APIä¸å¯ç”¨ å®‰è£…ç»„ä»¶ 1wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.2/components.yaml -O metrics-server-components.yaml ç¼–è¾‘æ–‡ä»¶ï¼Œæ‰¾åˆ°containersè¿›è¡Œä¿®æ”¹ 1vim metrics-server-components.yaml 12345678910spec: containers: - args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname - --kubelet-use-node-status-port - --metric-resolution=15s - --kubelet-insecure-tls # é»˜è®¤ä¸ä½¿ç”¨https image: registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server:v0.6.2 # ä½¿ç”¨å›½å†…é•œåƒåœ°å€ å®‰è£…å·¥å…· 1kubectl apply -f metrics-server-components.yam æŸ¥çœ‹è¿è¡ŒçŠ¶æ€ æ£€æµ‹èµ„æºçš„å ç”¨æƒ…å†µ 1kubectl -n zy-test top pods æµ‹è¯•ï¼Œè®©nginxçš„å¹¶å‘å‹åŠ›å‡é«˜åˆ›å»ºSVC ç¡®è®¤æˆ‘ä»¬podçš„ipç«¯å£ 1kubectl -n zy-test get pods -o wide æ–°å»ºyaml 1vim nginx-svc.yml 123456789101112131415apiVersion: v1kind: Servicemetadata: name: nginx-svc labels: app: nginx namespace: &quot;zy-test&quot;spec: selector: app: negix-deploy ports: - port: 80 targetPort: 80 name: web type: NodePort åˆ›å»ºsvc 1kubectl create -f nginx-svc.yml æŸ¥çœ‹åˆ›å»ºçš„svc 1kubectl -n zy-test get svc ä½¿ç”¨ä¸€ä¸ªæ­»å¾ªç¯çš„è„šæœ¬è¿›è¡Œæµ‹è¯• æ‰§è¡Œè„šæœ¬ 1while true; do wget -q -O- http://10.244.249.52 &gt; /dev/null ; done æŸ¥çœ‹æˆ‘ä»¬çš„hpaï¼Œå·²ç»è¶…è¿‡äº†20% 1kubectl -n zy-test get hpa æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ æŸ¥çœ‹deployï¼Œ å·²ç»å¸®æˆ‘ä»¬è¿›è¡Œäº†æ‰©å®¹ 1kubectl -n zy-test get deploy ç»“æŸæ­»å¾ªç¯ ç¨ç­‰å†æŸ¥çœ‹æˆ‘ä»¬çš„HPAå’Œtop 1kubectl -n zy-test get hpa 1kubectl -n zy-test top po èµ„æºé™ä¸‹æ¥åè¦ç­‰ä¸€æ®µæ—¶é—´åæ‰ä¼šæ…¢æ…¢å¸®åŠ©æˆ‘ä»¬ç¼©å®¹","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"HPA","slug":"HPA","permalink":"http://jimoblivion.github.io/tags/HPA/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šDaemonSetåº”ç”¨","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šDaemonSetåº”ç”¨","date":"2023-07-19T12:35:18.000Z","updated":"2023-07-19T13:53:44.850Z","comments":true,"path":"2023/07/19/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šDaemonSetåº”ç”¨/","link":"","permalink":"http://jimoblivion.github.io/2023/07/19/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%83%EF%BC%89%EF%BC%9ADaemonSet%E5%BA%94%E7%94%A8/","excerpt":"","text":"è¯´æ˜DaemonSetä¸ºæˆ‘ä»¬æ¯ä¸€ä¸ªåŒ¹é…åˆ°çš„Nodeéƒ¨ç½²ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ åˆ›å»º é…ç½®yamlæ–‡ä»¶ï¼Œå¹¶ä¸”åˆ›å»ºDaemonSet 1vim nginx-ds.yml 1234567891011121314151617181920212223242526272829303132333435apiVersion: apps/v1kind: DaemonSetmetadata: name: fluentd namespace: zy-testspec: revisionHistoryLimit: 10 selector: matchLabels: app: logging template: metadata: labels: app: logging id: fluentd name: fluentd spec: containers: - name: fluentd-es image: agilestacks/fluentd-elasticsearch:v1.3.0 env: - name: FLUENTD_ARGS value: -qq volumeMounts: - name: containers mountPath: /var/lib/docker/containers - name: varlog mountPath: /var/log volumes: - hostPath: path: /var/lib/docker/containers name: containers - hostPath: path: /var/log name: varlog åˆ›å»ºdaemonset 1kubectl create -f nginx-ds.yml æŸ¥çœ‹åˆ›å»ºçš„ds æŒ‡å®šnodeèŠ‚ç‚¹DaemonSetä¼šå¿½ç•¥Nodeçš„unschedulableçŠ¶æ€ï¼Œæœ‰ä¸¤ç§æ–¹å¼æ¥æŒ‡å®špodåªè¿è¡Œå†æŒ‡å®šçš„NodeèŠ‚ç‚¹ä¸Šï¼š nodeSelector: åªè°ƒåº¦åˆ°åŒ¹é…labelçš„Nodeä¸Š nodeAffinityï¼ˆèŠ‚ç‚¹äº²å’ŒåŠ›ï¼‰: åŠŸèƒ½æ›´ä¸°å¯Œçš„Nodeé€‰æ‹©å™¨ï¼Œæ¯”å¦‚æ”¯æŒé›†åˆæ“ä½œ podAffinityï¼ˆPodäº²å’ŒåŠ›ï¼‰: è°ƒåº¦åˆ°æ»¡è¶³æ¡ä»¶ çš„podæ‰€åœ¨çš„Nodeä¸Š ä½¿ç”¨NodeSelector æŸ¥çœ‹èŠ‚ç‚¹çš„labelæ ‡ç­¾ 1kubectl get nodes --show-labels ç»™workerèŠ‚ç‚¹æ‰“æ ‡ç­¾ 1kubectl label no k8snode1 type=microservices ç¡®è®¤æ ‡ç­¾å·²ç»æ‰“ä¸Š ç»™daemonseté…ç½®ä¸­è®¾ç½®nodeSelector 1kubectl -n zy-test edit ds fluentd 12345678910111213141516spec: revisionHistoryLimit: 10 selector: matchLabels: app: logging template: metadata: creationTimestamp: null labels: app: logging id: fluentd name: fluentd spec: nodeSelector: type: microservices # ä¿®æ”¹ containers: ä¿å­˜æˆåŠŸå \\ 1kubectl -n zy-test get po -l app=logging -o wide ä½¿ç”¨labelæ¡ä»¶ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ å¦‚æœæˆ‘ä»¬éœ€è¦ç»™æŒ‡å®šèŠ‚ç‚¹éƒ¨ç½²daemonsetï¼Œåªéœ€è¦ç»™æˆ‘ä»¬çš„èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾å³å¯ 1kubectl label no $&#123;node&#125; type=microservices æ›´æ–°ç­–ç•¥DaemonSeté»˜è®¤çš„æ›´æ–°ç­–ç•¥æ˜¯æ»šåŠ¨æ›´æ–° 12345updateStrategy: rollingUpdate: maxSurge: 0 maxUnavailable: 1 type: RollingUpdate ä¸å»ºè®®ä½¿ç”¨RollingUpdateï¼Œå»ºè®®ä½¿ç”¨OnDeleteæ¨¡å¼ï¼Œè¿™æ ·é¿å…é¢‘ç¹æ›´æ–°dsï¼Œéœ€è¦æ›´æ–°çš„podåˆ é™¤å³å¯ï¼Œ å‡å°‘èµ„æºçš„å ç”¨ 12updateStrategy: type: Ondelete","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"DaemonSet","slug":"DaemonSet","permalink":"http://jimoblivion.github.io/tags/DaemonSet/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…­ï¼‰ï¼šStatefulSetæ›´æ–°","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…­ï¼‰ï¼šStatefulSetæ›´æ–°","date":"2023-07-19T10:22:23.000Z","updated":"2023-07-19T13:03:57.166Z","comments":true,"path":"2023/07/19/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå…­ï¼‰ï¼šStatefulSetæ›´æ–°/","link":"","permalink":"http://jimoblivion.github.io/2023/07/19/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9AStatefulSet%E6%9B%B4%E6%96%B0/","excerpt":"","text":"rollingUpdateæ»šåŠ¨æ›´æ–° ç”±äºpodæ˜¯æœ‰åºçš„ï¼Œåœ¨StatefulSetä¸­æ›´æ–°æ˜¯åŸºäºpodçš„é¡ºåºå€’åºæ›´æ–°ã€‚ ç°åº¦å‘å¸ƒï¼ˆé‡‘ä¸é›€å‘å¸ƒï¼‰ ç›®çš„æ˜¯å°†ä¸Šçº¿åäº§ç”Ÿé—®é¢˜çš„å½±å“é™ä½åˆ°æœ€ä½ åˆ©ç”¨æ»šåŠ¨æ›´æ–°ä¸­çš„partitionå±æ€§ï¼Œå®ç°ç°åº¦å‘å¸ƒçš„æ•ˆæœï¼š ä¾‹å¦‚æˆ‘ä»¬æœ‰5ä¸ªpodï¼Œå¦‚æœå½“å‰çš„partitionè®¾ç½®ä¸º3ï¼Œé‚£ä¹ˆæ­¤æ—¶æ»šåŠ¨æ›´æ–°æ—¶ï¼Œåªä¼šæ›´æ–°é‚£äº›åºå·&gt;&#x3D;3çš„podã€‚ å¯ä»¥æ§åˆ¶partitionçš„å€¼ï¼Œå†³å®šåªæ›´æ–°å…¶ä¸­ä¸€éƒ¨åˆ†podï¼Œç¡®è®¤æ²¡æœ‰é—®é¢˜åå†é€æ¸å¢å¤§æ›´æ–°podçš„æ•°é‡ï¼Œæœ€ç»ˆå®ç°å…¨éƒ¨podæ›´æ–°ã€‚ ç¼–è¾‘statefulsetï¼Œ ä¿®æ”¹partitionçš„æ•°é‡ä¸º1 1kubectl -n zy-test edit sts web 12345##### ä¿®æ”¹ updateStrategy: rollingUpdate: partition: 1 type: RollingUpdate æ›´æ–°sts 1kubectl -n zy-test patch statefulset web --type=&#x27;json&#x27; -p=&#x27;[&#123;&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/template/spec/containers/0/image&quot;,&quot;value&quot;:&quot;nginx:1.7.1&quot;&#125;]&#x27; ç¡®è®¤ï¼Œ web-0çš„æœªæ›´æ–° 1kubectl -n zy-test describe po web-0 web-1é•œåƒç‰ˆæœ¬æ›´æ–°æˆåŠŸ ç¼–è¾‘statefulsetï¼Œ ä¿®æ”¹partitionçš„æ•°é‡ä¸º0ï¼ˆå®ç°é•œåƒçš„å…¨éƒ¨æ›´æ–°ï¼‰ 1kubectl -n zy-test edit sts web 12345##### updateStrategy: rollingUpdate: partition: 0 type: RollingUpdate æ›´æ–°æˆåŠŸåï¼ŒæŸ¥çœ‹é•œåƒç‰ˆæœ¬å·²ç»æ›´æ–°æˆåŠŸ 1kubectl -n zy-test describe po web-0 è®¾ç½®ä¸ºå½“åˆ é™¤podæ—¶æ›´æ–° ä¿®æ”¹yaml 12updateStrategy:type: OnDelete ä¿®æ”¹ç‰ˆæœ¬ 1kubectl -n zy-test patch statefulset web --type=&#x27;json&#x27; -p=&#x27;[&#123;&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/template/spec/containers/0/image&quot;,&quot;value&quot;:&quot;nginx:1.9.1&quot;&#125;]&#x27; æ­¤æ—¶æŸ¥çœ‹podè¯¦æƒ…ï¼Œé•œåƒç‰ˆæœ¬æœªå‘ç”Ÿå˜åŒ– 1kubectl -n zy-test describe po web-0 åˆ é™¤pod 1kubectl -n zy-test delete po web-0 åˆ é™¤podåä¼šé‡å¯æ–°çš„pod:web-0 å¯¹web-0çš„podè¿›è¡Œæè¿° 1kubectl -n zy-test describe po web-0 çº§è”åˆ é™¤å®šä¹‰åˆ é™¤statefulsetæ—¶ä¼šåŒæ—¶åˆ é™¤podsã€‚åˆ é™¤statefulsetï¼Œ æ­¤æ—¶podè¢«åˆ é™¤ï¼Œä½†æ˜¯svcä¸ä¼šè¢«åˆ é™¤ æµ‹è¯• åˆ é™¤sts 1kubectl -n zy-test delete sts web åˆ é™¤svc 1kubectl -n zy-test delete svc nginx éçº§è”åˆ é™¤ æ‰§è¡Œéçº§è”åˆ é™¤ 1kubectl -n zy-test delete sts web --cascade=false stsåˆ é™¤æˆåŠŸï¼Œä½†æ˜¯podå’Œsvcæœªåˆ é™¤ åˆ é™¤podå’Œsvc 12kubectl -n zy-test delete po web-0 web-1kubectl -n zy-test delete svc nginx åˆ é™¤pvc statefulsetè¢«åˆ é™¤ä»¥åPVCè¿˜ä¼šè¢«ä¿ç•™ï¼Œæ•°æ®ä¸å†ä½¿ç”¨çš„ä¹Ÿéœ€è¦åˆ é™¤ 12kubectl -n zy-test get pvckubectl -n zy-test delete pvc www-web-0","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"StatefulSet","slug":"StatefulSet","permalink":"http://jimoblivion.github.io/tags/StatefulSet/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäº”ï¼‰ï¼šStatefulSetæœ‰çŠ¶æ€æœåŠ¡","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäº”ï¼‰ï¼šStatefulSetæœ‰çŠ¶æ€æœåŠ¡","date":"2023-07-19T06:10:04.000Z","updated":"2023-07-19T10:57:28.799Z","comments":true,"path":"2023/07/19/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäº”ï¼‰ï¼šStatefulSetæœ‰çŠ¶æ€æœåŠ¡/","link":"","permalink":"http://jimoblivion.github.io/2023/07/19/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%94%EF%BC%89%EF%BC%9AStatefulSet%E6%9C%89%E7%8A%B6%E6%80%81%E6%9C%8D%E5%8A%A1/","excerpt":"","text":"è¯´æ˜ StatefulSetæ˜¯ä¸“é—¨é’ˆå¯¹æœ‰çŠ¶æ€æœåŠ¡è¿›è¡Œéƒ¨ç½²çš„ä¸€ä¸ªæ§åˆ¶å™¨ã€‚ åˆ›å»º åˆ›å»ºyaml 1vim nginx-ss.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051---apiVersion: v1kind: Servicemetadata: name: nginx labels: app: nginx namespace: &quot;zy-test&quot;spec: ports: - port: 80 name: web clusterIP: None selector: app: nginx---apiVersion: apps/v1kind: StatefulSetmetadata: name: web namespace: &quot;zy-test&quot;spec: serviceName: &quot;nginx&quot; replicas: 2 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80 name: web volumeMounts: - name: www mountPath: /usr/share/nginx/html volumeClaimTemplates: - metadata: name: www annotations: volume.alpha.kubernetes.io/storage-class: anything spec: accessModes: [ &quot;ReadWriteOnce&quot; ] resources: requests: storage: 1Gi åˆ›å»ºstatefulset 1kubectl create -f nginx-ss.yml æŸ¥çœ‹pod 1kubectl -n zy-test get pod æŸ¥çœ‹pvc 1kubectl -n zy-test get pvc æŸ¥çœ‹sts 1kubectl -n zy-test get sts æŸ¥çœ‹ç§æœ‰å· 1kubectl -n zy-test get pvc æŸ¥çœ‹pvcçš„æè¿°ï¼Œæ­¤æ—¶statefulSetåˆ›å»ºå¤±è´¥ï¼ŒåŸå› æ˜¯æ²¡æœ‰å¯ç”¨çš„æŒä¹…å· 1kubectl -n zy-test describe pvc æŸ¥çœ‹sts 1kubectl -n zy-test get sts æ‰€ä»¥æ­¤å¤„å°†å­˜å‚¨å·ç›¸å…³å†…å®¹è¿›è¡Œåˆ é™¤ï¼Œå¹¶ä¸”é‡æ–°åˆ›å»ºsts StatefulSetä¸­æ¯ä¸ªPodçš„DNSæ ¼å¼ä¸ºstatefulSetName-(0..N-1).serviceName.namespace.svc.cluster.local serviceNameä¸ºHeadless Serviceçš„åå­— 0..N-1ä¸ºPodæ‰€åœ¨çš„åºå·ï¼Œä»0å¼€å§‹åˆ°N-1 statefulSetNameä¸ºStatefulSetçš„åå­— namespaceä¸ºæœåŠ¡æ‰€åœ¨çš„namespaceï¼ŒHeadless Serviceå’ŒStatefulSetå¿…é¡»åœ¨æƒ³ç”¨çš„namespace .cluster.localä¸ºCluster Domain 1234567891011121314# ä»¥ä¸‹éœ€è¦åˆ é™¤çš„å†…å®¹volumeMounts: - name: www mountPath: /usr/share/nginx/htmlvolumeClaimTemplates:- metadata: name: www annotations: volume.alpha.kubernetes.io/storage-class: anything spec: accessModes: [ &quot;ReadWriteOnce&quot; ] resources: requests: storage: 1Gi åˆ›å»ºæˆåŠŸåï¼Œè¿›å…¥å®¹å™¨å†…éƒ¨ï¼Œè§£ædnså¹¶ä¸”ä½¿ç”¨web-0.nginxè®¿é—®åˆ›å»ºçš„å®¹å™¨ 1kubectl run -it --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh æ“ä½œstsæ‰©å®¹å’Œç¼©å®¹ æ‰§è¡Œæ‰©å®¹ 1kubectl -n zy-test scale statefulset web --replicas=3 æ‰§è¡Œç¼©å®¹ 1kubectl -n zy-test scale statefulset web --replicas=2 æŸ¥çœ‹æ‰©å®¹å’Œç¼©å®¹çš„è¿‡ç¨‹ 1kubectl -n zy-test describe sts web stsæ›´æ–° é•œåƒæ›´æ–° 1kubectl -n zy-test patch statefulset web --type=&#x27;json&#x27; -p=&#x27;[&#123;&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/template/spec/containers/0/image&quot;,&quot;value&quot;:&quot;nginx:1.9.1&quot;&#125;]&#x27; æŸ¥çœ‹æ›´æ–°çŠ¶æ€ 1kubectl -n zy-test rollout status statefulset web æŸ¥çœ‹æ›´æ–°å†å² 1kubectl -n zy-test rollout history statefulset web å›é€€åˆ°æŒ‡å®šçš„å†å²ç‰ˆæœ¬ 1kubectl -n zy-test rollout history statefulset web --revision=2","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"StatefulSet","slug":"StatefulSet","permalink":"http://jimoblivion.github.io/tags/StatefulSet/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå››ï¼‰ï¼šèµ„æºè°ƒåº¦Deployment","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå››ï¼‰ï¼šèµ„æºè°ƒåº¦Deployment","date":"2023-07-18T10:20:17.000Z","updated":"2023-07-19T03:59:28.880Z","comments":true,"path":"2023/07/18/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆå››ï¼‰ï¼šèµ„æºè°ƒåº¦Deployment/","link":"","permalink":"http://jimoblivion.github.io/2023/07/18/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E8%B5%84%E6%BA%90%E8%B0%83%E5%BA%A6Deployment/","excerpt":"","text":"è¯´æ˜Deploymentæ˜¯ç”¨æ¥ç®¡ç†podå’ŒReplicas podéƒ¨ç½²ã€å‰¯æœ¬è®¾å®šã€æ»šåŠ¨å‡çº§ã€å›æ»šç­‰åŠŸèƒ½ã€‚ åˆ›å»ºç¼–è¾‘yml1vim nginx-deploy.yaml 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162apiVersion: apps/v1kind: Deploymentmetadata: annotations: deployment.kubernetes.io/revision: &quot;1&quot; creationTimestamp: &quot;2023-06-30T05:22:41Z&quot; generation: 1 labels: app: nginx-deploy name: nginx-deploy namespace: zy-test resourceVersion: &quot;18422&quot; uid: dac95cad-f455-4ca4-a8cd-569d8bbfdfdcspec: progressDeadlineSeconds: 600 replicas: 1 revisionHistoryLimit: 10 # æŒ‡å®šdeploymentä¿ç•™å¤šå°‘revision,å¦‚æœè®¾ç½®ä¸º0ï¼Œåˆ™ä¸å…è®¸deploymentå›é€€ selector: matchLabels: app: nginx-deploy strategy: rollingUpdate: maxSurge: 25% maxUnavailable: 25% type: RollingUpdate template: metadata: creationTimestamp: null labels: app: nginx-deploy spec: containers: - image: nginx:1.7.9 imagePullPolicy: IfNotPresent name: nginx resources: &#123;&#125; terminationMessagePath: /dev/termination-log terminationMessagePolicy: File dnsPolicy: ClusterFirst restartPolicy: Always schedulerName: default-scheduler securityContext: &#123;&#125; terminationGracePeriodSeconds: 30status: availableReplicas: 1 conditions: - lastTransitionTime: &quot;2023-06-30T05:22:43Z&quot; lastUpdateTime: &quot;2023-06-30T05:22:43Z&quot; message: Deployment has minimum availability. reason: MinimumReplicasAvailable status: &quot;True&quot; type: Available - lastTransitionTime: &quot;2023-06-30T05:22:41Z&quot; lastUpdateTime: &quot;2023-06-30T05:22:43Z&quot; message: ReplicaSet &quot;nginx-deploy-78d8bf4fd7&quot; has successfully progressed. reason: NewReplicaSetAvailable status: &quot;True&quot; type: Progressing observedGeneration: 1 readyReplicas: 1 replicas: 1 updatedReplicas: 1 åˆ›å»ºdeploy æ‰§è¡Œåˆ›å»ºè„šæœ¬ 1kubectl -n zy-test create deploy nginx-deploy.yaml æŸ¥çœ‹æˆ‘ä»¬çš„po, rsï¼Œdeployå¹¶ä¸”æ˜¾ç¤ºlabels 1kubectl -n zy-test get po,rs,deploy --show-labels æ»šåŠ¨æ›´æ–°åªæœ‰ä¿®æ”¹äº†deploymenté…ç½®æ–‡ä»¶ä¸­çš„templateä¸­çš„å±æ€§åï¼Œæ‰ä¼šè§¦å‘æ›´æ–°æ“ä½œ ä¿®æ”¹é•œåƒç‰ˆæœ¬å· 1kubectl -n zy-test set image deployment/nginx-deploy nginx=nginx:1.9.1 ç›‘æ§èŠ‚ç‚¹çŠ¶æ€ 1kubectl -n zy-test get deploy -w æŸ¥çœ‹deploymentçš„æè¿°, ç‰ˆæœ¬å·å·²ç»æ›´æ–° 1kubectl -n zy-test describe deployment/nginx-deploy æˆ–è€…å¯ä»¥ç›´æ¥ç¼–è¾‘ä¿å­˜deploymentï¼Œæ•ˆæœä¸€æ · 1kubectl -n zy-test edit deploy nginx-deploy æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€ 1kubectl -n zy-test rollout status deploy nginx-deploy é€šè¿‡IdæŸ¥çœ‹poï¼Œrs, deployä¹‹é—´çš„å…³ç³» 123kubectl -n zy-test get deploy --show-labelskubectl -n zy-test get rs --show-labelskubectl -n zy-test get po --show-labels ç‰ˆæœ¬å›æ»šå½“æˆ‘ä»¬deploymentä¸ç¨³å®šï¼Œæ¯”å¦‚ä¸€ç›´crash loopingï¼Œæ­¤æ—¶æˆ‘ä»¬å¯èƒ½éœ€è¦å›é€€ä¹‹å‰çš„ç‰ˆæœ¬ã€‚é»˜è®¤ç³»ç»Ÿä¸­ä¼šä¿å­˜å‰ä¸¤æ¬¡çš„rolloutè®°å½•ï¼Œå¯ä»¥ä¿®æ”¹revision history limitæ¥æ›´æ”¹revisionçš„æ•°é‡ã€‚ æ¨¡æ‹Ÿä¸å°å¿ƒå†™é”™é•œåƒç‰ˆæœ¬ï¼ˆä¿®æ”¹ä¸€ä¸ªä¸å­˜åœ¨çš„nginxçš„ç‰ˆæœ¬ï¼‰ 1kubectl -n zy-test set image deployment/nginx-deploy nginx=nginx:1.91 æŸ¥çœ‹æ»šåŠ¨å‡çº§çš„çŠ¶æ€ï¼Œå‘ç° æ›´æ–°è¿‡ç¨‹è¢«å¡ä½ 1kubectl -n zy-test rollout status deploy nginx-deploy æŸ¥çœ‹æˆ‘ä»¬rså’Œpodçš„ä¿¡æ¯ï¼Œä¼šå‘ç°ErrImagePullçš„ä¿¡æ¯ 12kubectl -n zy-test get rs kubectl -n zy-test get pods æŸ¥çœ‹æˆ‘ä»¬å¯ä»¥å›é€€çš„revisionçš„åˆ—è¡¨ 1kubectl -n zy-test rollout history deployment/nginx-deploy æŸ¥çœ‹ç‰ˆæœ¬è¯¦æƒ… 1kubectl -n zy-test rollout history deployment/nginx-deploy --revision=2 ç¡®è®¤éœ€è¦å›é€€åï¼Œè¿›è¡Œç‰ˆæœ¬å›é€€ 1kubectl -n zy-test rollout undo deployment/nginx-deploy ä¹Ÿå¯ä»¥æŒ‡å®šç‰ˆæœ¬è¿›è¡Œå›é€€ 1kubectl -n zy-test rollout undo deploy nginx-deploy --to-revision=2 æŸ¥çœ‹å›é€€ç‰ˆæœ¬ådeploymentä¿¡æ¯ 1kubectl -n zy-test describe deploy nginx-deploy 12kubectl -n zy-test rollout undo deploy nginx-deploy --to-revision=1kubectl -n zy-test describe deploy nginx-deploy æ‰©å®¹å’Œç¼©å®¹é€šè¿‡kube scaleå‘½ä»¤å¯ä»¥è¿›è¡Œæ‰©å®¹å’Œç¼©å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨kube editç¼–è¾‘replicaså®ç°æ‰©å®¹å’Œç¼©å®¹ã€‚æ‰©å®¹å’Œç¼©å®¹åªæ˜¯åˆ›å»ºå‰¯æœ¬æ•°é‡ï¼Œæ²¡æœ‰æ›´æ–°pod templateæ‰€ä»¥ä¸ä¼šåˆ›å»ºæ–°çš„rsã€‚ æ‰©å®¹ æ‰§è¡Œæ‰©å®¹æ“ä½œ 1kubectl -n zy-test scale --replicas=2 deploy nginx-deploy æŸ¥çœ‹æ‰©å®¹åçŠ¶æ€ 123kubectl -n zy-test get pokubectl -n zy-test get deploykubectl -n zy-test get rs ç¼©å®¹ æ‰§è¡Œç¼©å®¹æ“ä½œ 1kubectl -n zy-test scale --replicas=1 deploy nginx-deploy æŸ¥çœ‹ç¼©å®¹åçŠ¶æ€ 123kubectl -n zy-test get pokubectl -n zy-test get deploykubectl -n zy-test get rs æ›´æ–°çš„æš‚åœå’Œæ¢å¤ç”±äºæˆ‘ä»¬æ¯æ¬¡å¯¹pod templateä¸­çš„ä¿¡æ¯å‘ç”Ÿä¿®æ”¹åï¼Œéƒ½ä¼šè§¦å‘æ›´æ–°deploymentæ“ä½œã€‚é‚£ä¹ˆæ­¤æ—¶å¦‚æœé¢‘å‘ä¿®æ”¹ä¿¡æ¯ï¼Œå°±ä¼šäº§ç”Ÿå¤šæ¬¡æ›´æ–°ï¼Œä½†æ˜¯æˆ‘ä»¬å®é™…ä¸Šåªéœ€è¦æœ€åä¸€æ¬¡æ›´æ–°ã€‚è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¯ä»¥æš‚åœdeploymentçš„rolloutã€‚ æš‚åœæ›´æ–° æ‰§è¡Œæš‚åœè„šæœ¬ 1kubectl -n zy-test rollout pause deployment nginx-deploy ç›‘å¬æˆ‘ä»¬podçš„çŠ¶æ€ 1kubectl -n zy-test get po -w æ›´æ–°podçš„ä¸­é•œåƒçš„ç‰ˆæœ¬ 1kubectl -n zy-test set image deploy nginx-deploy nginx=nginx:1.19.1 å¯ä»¥çœ‹åˆ°podæ²¡æœ‰å‘ç”Ÿå˜åŒ– æˆ‘ä»¬å†æ¬¡ä¿®æ”¹ä¸€äº›å±æ€§ 1kubectl -n zy-test set resources deploy nginx-deploy -c nginx --limits=cpu=200m,memory=128Mi --requests=cpu=100m,memory=64Mi æ ¼å¼åŒ–è¾“å‡ºdeploymentç¡®è®¤ä¿®æ”¹é¡¹ï¼Œç¡®è®¤ä¿®æ”¹æˆåŠŸ 1kubectl -n zy-test get deploy nginx-deploy -o yaml ä»æš‚åœä¸­æ¢å¤ æ‰§è¡ŒçŠ¶æ€æ¢å¤è„šæœ¬ 1kubectl -n zy-test rollout resume deploy nginx-deploy æ­¤æ—¶podçš„çŠ¶æ€å‘ç”Ÿäº†å˜æ›´ æŸ¥çœ‹æ›´æ–°å†å²å’Œè¯¦æƒ… 1kubectl -n zy-test rollout history deploy nginx-deploy 1kubectl -n zy-test rollout history deploy nginx-deploy --revision=8","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"deployment","slug":"deployment","permalink":"http://jimoblivion.github.io/tags/deployment/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šæ ‡ç­¾label","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šæ ‡ç­¾label","date":"2023-07-17T13:22:16.000Z","updated":"2023-07-19T02:45:44.599Z","comments":true,"path":"2023/07/17/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸‰ï¼‰ï¼šæ ‡ç­¾label/","link":"","permalink":"http://jimoblivion.github.io/2023/07/17/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E6%A0%87%E7%AD%BElabel/","excerpt":"","text":"æ·»åŠ ä¸´æ—¶æ ‡ç­¾ 1kubectl -n zy-test label po nginx-pod app=hello ä½¿ç”¨æ ‡ç­¾æŸ¥çœ‹pod 1kubectl -n zy-test get po -A -l app=hello ä½¿ç”¨æ ‡ç­¾æŸ¥çœ‹podï¼Œå¹¶ä¸”å±•ç¤ºlabelå±æ€§ 1kubectl -n zy-test get po -A -l app=hello --show-labels æŸ¥çœ‹podä¸Šçš„labelè¯¦æƒ… 1kubectl -n zy-test edit po nginx-pod åŒä¸€ä¸ªæ ‡ç­¾åŒ¹é…å¤šä¸ªlabelå€¼ 1kubectl -n zy-test get po -l &#x27;app in (hello,test)&#x27; å¤šæ¡ä»¶æŸ¥è¯¢ 1kubectl -n zy-test get po -l &#x27;app in (hello,test), type in (app)&#x27; åå‘åŒ¹é… 1kubectl -n zy-test get po -l &#x27;app!=test&#x27;","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"label","slug":"label","permalink":"http://jimoblivion.github.io/tags/label/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒï¼‰ï¼špodçš„ç”Ÿå‘½å‘¨æœŸ","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒï¼‰ï¼špodçš„ç”Ÿå‘½å‘¨æœŸ","date":"2023-07-14T06:57:57.000Z","updated":"2023-07-18T15:27:27.426Z","comments":true,"path":"2023/07/14/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆäºŒï¼‰ï¼špodçš„ç”Ÿå‘½å‘¨æœŸ/","link":"","permalink":"http://jimoblivion.github.io/2023/07/14/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9Apod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/","excerpt":"","text":"Podé€€å‡º Endpointåˆ é™¤podçš„ipåœ°å€ Podå˜æˆTerminatingçŠ¶æ€ æ‰§è¡ŒpreStopçš„æŒ‡ä»¤ PreStopåº”ç”¨ æ³¨å†Œä¸­å¿ƒä¸‹çº¿ æ•°æ®æ¸…ç† æ•°æ®é”€æ¯ é…ç½®é¡¹æè¿°terminationGracePeriodSeconds: Podæ‰§è¡Œåˆ é™¤æ“ä½œçš„æ—¶å€™è¿˜èƒ½ç»´æŒä¸€æ®µæ—¶é—´ï¼Œè®©podå»æ‰§è¡Œä¸€äº›æ¸…ç†æˆ–è€…é”€æ¯çš„æ“ä½œï¼š 1234# ä½œç”¨äºpodä¸­çš„æ‰€æœ‰å®¹å™¨terminationGracePeriodSeconds: 30containers: - xxx postStart: commandå’ŒpostStartå¯èƒ½åŒæ—¶æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯å®¹å™¨åˆ›å»ºå®Œæˆåæ‰§è¡Œçš„åŠ¨ä½œï¼Œä¸èƒ½ä¿è¯è¯¥æ“ä½œä¸€å®šåœ¨å®¹å™¨çš„commandä¹‹å‰æ‰§è¡Œã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¸postStart, è€Œæ˜¯ä½¿ç”¨åˆå§‹åŒ–å®¹å™¨initCã€‚ preStop: åœ¨å®¹å™¨åœæ­¢å‰æ‰§è¡Œçš„åŠ¨ä½œã€‚ å®è·µ åˆ›å»ºpod 1vim nginx-pod.yml 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748apiVersion: v1kind: Podmetadata:name: nginx-podlabels: type: app test: 1.0.0namespace: &#x27;zy-test&#x27;spec:containers:- name: nginx image: nginx:1.7.9 imagePullPolicy: IfNotPresent # æ–°å¢ begin lifecycle: postStart: # ç”Ÿå‘½å‘¨æœŸä¹‹å‰ ä¸èƒ½ä¿è¯åœ¨å®¹å™¨çš„ command ä¹‹å‰ï¼Œä¸€èˆ¬ä¸ç”¨ exec: command: - sh - -c - &quot;echo &#x27;pre stop&#x27; &gt; /usr/share/nginx/html/prestop.html&quot; # &lt;&gt;éœ€è¦è½¬ä¹‰ preStop: # ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶æ‰§è¡Œ exec: command: - sh - -c - &quot;sleep 50; echo &#x27;sleep finished...&#x27; &gt;&gt; /usr/share/nginx/html/prestop.html&quot; # æ–°å¢ end command: - nginx - -g - &#x27;daemon off;&#x27; workingDir: /usr/share/nginx/html ports: - name: http containerPort: 80 protocol: TCP env: - name: JVM_OPTS value: &#x27;-Xms128m -Xmx128m&#x27; resources: requests: cpu: 100m memory: 128Mi limits: cpu: 200m memory: 256MirestartPolicy: OnFailure 1kubectl create -f nginx-pod.yml æŸ¥çœ‹podï¼Œå¹¶ä¸”æµ‹è¯• postStart æ˜¯å¦ç”Ÿæ•ˆ 12kubectl -n zy-test get pod -o widecurl 10.244.249.10/prestop.html åˆ é™¤podï¼Œæµ‹è¯• preStop æ˜¯å¦ç”Ÿæ•ˆ 123# æŸ¥çœ‹podçš„ipkubectl -n zy-test delete pod nginx-podcurl 10.244.249.10/prestop.html æ–°å¢ terminationGracePeriodSeconds è®¾ç½®é”€æ¯åå®½é™æ—¶é—´ 12spec:terminationGracePeriodSeconds: 15 # å®¹å™¨é”€æ¯å‰ç»™çš„å®½é™æ—¶é—´ 12# ç›‘å¬åˆ é™¤å‘½ä»¤æ‰§è¡Œçš„æ—¶é—´time kubectl -n zy-test delete pod nginx-pod æˆ‘ä»¬å¯ä»¥åœ¨åˆ é™¤podçš„åŒæ—¶æŒç»­ç›‘å¬podçš„çŠ¶æ€ 1kubectl -n zy-test get pod -w å¦‚éœ€è½¬è½½è¯·è¯´æ˜å‡ºå¤„","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"pod","slug":"pod","permalink":"http://jimoblivion.github.io/tags/pod/"}]},{"title":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šåˆ›å»ºpod","slug":"Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šåˆ›å»ºpod","date":"2023-07-12T08:25:20.000Z","updated":"2023-07-19T02:45:02.238Z","comments":true,"path":"2023/07/12/Kuberneteså®æˆ˜ç¬”è®°ï¼ˆä¸€ï¼‰ï¼šåˆ›å»ºpod/","link":"","permalink":"http://jimoblivion.github.io/2023/07/12/Kubernetes%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%88%9B%E5%BB%BApod/","excerpt":"","text":"æ¦‚å¿µpodæ˜¯k8sçš„æœ€å°å·¥ä½œå•å…ƒ åˆ›å»ºpod åˆ›å»ºå‘½åç©ºé—´ 1Kubectl create namespace zy-test åˆ›å»ºpodç¼–å†™yaml 1vi nginx-pod.yml 123456789101112131415161718192021222324252627282930313233apiVersion: v1kind: Podmetadata: name: nginx-pod labels: type: app test: 1.0.0 namespace: &#x27;zy-test&#x27;spec: containers: - name: nginx image: nginx:1.7.9 imagePullPolicy: IfNotPresent command: - nginx - -g - &#x27;daemon off;&#x27; workingDir: /usr/share/nginx/html ports: - name: http containerPort: 80 protocol: TCP env: - name: JVM_OPTS value: &#x27;-Xms128m -Xmx128m&#x27; resources: requests: cpu: 100m memory: 128Mi limits: cpu: 200m memory: 256Mi restartPolicy: OnFailure æ‰§è¡Œåˆ›å»º 1kubectl create -f nginx-pod.yml æ­¤æ—¶podä¸€ç›´å¤„äºpendingçŠ¶æ€ 1Kubectl -n zy-test get pod | grep nginx-pod æŸ¥çœ‹podçš„æè¿° 1Kubectl -n zy-test describe pod nginx-pod Warning FailedScheduling 56s (x4 over 4m20s) default-scheduler 0&#x2F;1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io&#x2F;master: }, that the pod didnâ€™t tolerate. æ­¤æ—¶é»˜è®¤masterèŠ‚ç‚¹æ˜¯ä¸å…è®¸è°ƒåº¦podçš„ï¼Œè§£å†³åŠæ³• åˆ é™¤æ±¡ç‚¹æˆ–è€…æ–°å¢ä»èŠ‚ç‚¹ 1kubectl taint nodes --all node-role.kubernetes.io/master- æˆ‘ä»¬é‡‡ç”¨æ–°å¢ä»èŠ‚ç‚¹çš„æ–¹å¼ï¼šcloneæ–°çš„èŠ‚ç‚¹ä½œä¸ºä»èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¿®æ”¹é™æ€ipåœ°å€ è®¾ç½®å®Œæˆä¹‹å è®¾ç½®hostname 1hostnamectl set-hostname k8sNode1 é‡ç½®nodeèŠ‚ç‚¹ 1kubeadm reset åŠ å…¥masterèŠ‚ç‚¹ 123# æ‰§è¡Œç”±masterèŠ‚ç‚¹ç”Ÿæˆçš„tokenï¼Œåœ¨ä»èŠ‚ç‚¹æ‰§è¡Œkubeadm join 192.168.1.20:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:6d5a5dbc4cc7f67da955f1178e326cde55ed647613336a9fc990523bb6012b2e ç»™ä»èŠ‚ç‚¹æ‰“æ ‡ç­¾ 1kubectl label node k8snode1 node-role.kubernetes.io/worker=worker æ­¤æ—¶æŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºçš„nginxçš„podå·²ç»è¿è¡Œ podæ¢é’ˆ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨podæ¢é’ˆå¯ä»¥è·å–å½“å‰å®¹å™¨çš„æƒ…å†µï¼Œæ¢æµ‹æ–¹å¼æœ‰ exec: åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœè¿”å›å€¼ä¸º0ï¼Œåˆ™è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·çš„ tcpSocket: é€šè¿‡tcpè¿æ¥æ£€æµ‹å®¹å™¨å†…ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Œå¦‚æœå¼€æ”¾åˆ™è¯æ˜è¯¥å®¹å™¨å¥åº· httpGet: å‘é€HTTPè¯·æ±‚åˆ°å®¹å™¨å†…éƒ¨åº”ç”¨ç¨‹åºï¼Œå¦‚æœæ¥å£è¿”å›çŠ¶æ€ç åœ¨200-400ä¹‹é—´ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº· startupProbeç”¨äºåˆ¤æ–­ç¨‹åºæ˜¯å¦å·²ç»å¯åŠ¨ ä¿®æ”¹nginx-pod.yml 12345678910111213141516...containers:- name: nginx image: nginx:1.7.9 imagePullPolicy: IfNotPresent# æ–°å¢ begin startupProbe: httpGet: path: /api/path port: 80 failureThreshold: 3 periodSeconds: 10 successThreshold: 1 timeoutSeconds: 5 # æ–°å¢ end... å¯¹podè¿›è¡Œæè¿° 1kubectl describe pod -n zy-test nginx-pod ç¼–è¾‘podä¿®æ”¹ 1kubectl edit pod -n zy-test nginx-pod ä¿®æ”¹ 123startupProbe:httpGet: path: /index.html æŸ¥çœ‹podä¿¡æ¯ 1kubectl get pod -n zy-test nginx-pod -o wide åœ¨èŠ‚ç‚¹ä¸Šè®¿é—®è¯¥nginxé¦–é¡µ è·Ÿè¸ªpodæ—¥å¿— LivenessProbeç”¨äºæ¢æµ‹å®¹å™¨ä¸­åº”ç”¨æ˜¯å¦è¿è¡Œ ç¼–è¾‘podï¼Œæ–°å¢å¦‚ä¸‹é…ç½® 1234567891011121314containers:- name: nginx image: nginx:1.7.9 imagePullPolicy: IfNotPresent# æ–°å¢ begin livenessProbe: httpGet: path: /started.html #æµ‹è¯•ä¸å­˜åœ¨çš„è·¯å¾„ port: 80 failureThreshold: 3 periodSeconds: 180 successThreshold: 1 timeoutSeconds: 5 # æ–°å¢ end æ¯éš”ä¸€æ®µæ—¶é—´podä¼šè¢«æ€æ‰é‡å¯ æŸ¥çœ‹podæè¿° æ‹·è´æ–‡ä»¶start.htmlåˆ°å®¹å™¨ä¸­ 12echo &quot;&lt;h1&gt;start up!&lt;/h1&gt;&quot; &gt; start.htmlkubectl cp ./start.html zy-test/nginx-pod:/usr/share/nginx/html/start.html ç¡®è®¤æ–‡ä»¶å¯ä»¥è®¿é—® æŸ¥çœ‹podçš„æè¿°ï¼Œæ¢å¤æ­£å¸¸ ReadinessProbeç”¨äºæ¢æµ‹å®¹å™¨å†…çš„ç¨‹åºæ˜¯å¦å¥åº· åŒä¸Š å¦‚éœ€è½¬è½½è¯·è¯´æ˜å‡ºå¤„","categories":[{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"pod","slug":"pod","permalink":"http://jimoblivion.github.io/tags/pod/"}]},{"title":"Dockerå’ŒKuberneteså®‰è£…","slug":"Dockerå’ŒKuberneteså®‰è£…","date":"2023-07-12T05:39:49.000Z","updated":"2023-07-18T15:27:43.844Z","comments":true,"path":"2023/07/12/Dockerå’ŒKuberneteså®‰è£…/","link":"","permalink":"http://jimoblivion.github.io/2023/07/12/Docker%E5%92%8CKubernetes%E5%AE%89%E8%A3%85/","excerpt":"","text":"ç¯å¢ƒå‡†å¤‡ç³»ç»Ÿç‰ˆæœ¬ ç³»ç»Ÿ ç‰ˆæœ¬ CentOS release 7.8.2003 k8så’Œdockerçš„ç‰ˆæœ¬é€‰æ‹©Kubernetesç‰ˆæœ¬é€‰æ‹©1.23.1ä¹‹å‰çš„ï¼Œå› ä¸ºæ”¯æŒä½¿ç”¨docker è½¯ä»¶ ç‰ˆæœ¬ Kubernetesï¼ˆk8sï¼‰ 1.23.0 Docker 20.10.0.3 å®‰è£…dockerå®‰è£… å®‰è£…docker 1yum install -y docker-ce-20.10.0-3.el7 ç¼–è¾‘æ–‡ä»¶ 1vi /etc/docker/daemon.json æ·»åŠ å†…å®¹ 1234567891011&#123;&quot;registry-mirrors&quot;: [ &quot;https://kfwkfulq.mirror.aliyuncs.com&quot;, &quot;https://2lqq34jg.mirror.aliyuncs.com&quot;, &quot;https://pee6w651.mirror.aliyuncs.com&quot;, &quot;https://registry.docker-cn.com&quot;, &quot;http://hub-mirror.c.163.com&quot;],&quot;dns&quot;: [&quot;8.8.8.8&quot;,&quot;8.8.4.4&quot;],&quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]&#125; é‡å¯dockeræœåŠ¡ 1systemctl restart docker è®¾ç½®dockeræœåŠ¡å¼€æœºå¯åŠ¨ 1systemctl enable docker å®‰è£…docker-compose ä¸‹è½½docker-composeåˆ°éšæœºç›®å½• 1https://github.com/docker/compose/releases/download/v2.18.1/docker-compose-linux-x86_64 ç»™docker-composeæ‰§è¡Œæƒé™ 1chmod +x docker-compose-linux-x86_64 ä¿®æ”¹æ–‡ä»¶å 1mv docker-compose-linux-x86_64 docker-compose ç¡®è®¤ç¯å¢ƒå˜é‡ç›®å½• 1echo $PATH å°†docker-composeæ”¾å…¥ç¯å¢ƒå˜é‡æŒ‡å®šçš„ç›®å½•ï¼Œä½¿docker-composeéšå¤„å¯ä»¥æ‰§è¡Œ 1mv docker-compse /user/bin ç¡®è®¤é…ç½®æˆåŠŸ 1docker-compose version è®¾ç½®hostname, å¹¶ç¡®è®¤hostnameä¿®æ”¹æˆåŠŸ 12hostnamectl set-hostname k8sMasterhostname hostæ–‡ä»¶æ·»åŠ å¦‚ä¸‹ipå’Œhostnameçš„æ˜ å°„å…³ç³» 1echo &quot;127.0.0.1 $(hostname)&quot; &gt;&gt; /etc/hosts å®‰è£…k8s ç»„ä»¶å®‰è£… 1yum install -y kubelet-1.23.0 kubeadm-1.23.0 kubectl-1.23.0 ç”Ÿæˆä¸»èŠ‚ç‚¹é…ç½® 1kubeadm config print init-defaults &gt; kubeadm.yaml ä¿®æ”¹é…ç½®æ–‡ä»¶ kubeadm.yaml 123456######### :11ï¼Œä¿®æ”¹ ######### localAPIEndpoint: advertiseAddress: &lt;è¿™é‡Œæ¢æˆmasterçš„åœ°å€&gt; ######### :30ï¼Œä¿®æ”¹ ######### imageRepository: registry.aliyuncs.com/google_containers ######### :33ï¼Œæ–°å¢podSubnetè¿™ä¸€è¡Œ ######### networking: podSubnet: 10.244.0.0/16 ä¸»èŠ‚ç‚¹å¯åŠ¨ 123kubeadm config images pull --config kubeadm.yaml echo &quot;1&quot; &gt;/proc/sys/net/bridge/bridge-nf-call-iptables kubeadm init --config kubeadm.yaml ç”Ÿæˆä»èŠ‚ç‚¹åŠ å…¥ä¸»èŠ‚ç‚¹çš„token 123# å¯ä»¥æ‰§è¡Œè¯¥è„šæœ¬å°†ä»èŠ‚ç‚¹åŠ å…¥masterèŠ‚ç‚¹kubeadm join 192.168.1.20:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:6d5a5dbc4cc7f67da955f1178e326cde55ed647613336a9fc990523bb6012b2e å¦‚æœä½¿ç”¨érootç”¨æˆ·ï¼Œæƒ³è¦æ‰§è¡Œkubectlï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ 123mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config å¦‚æœä½¿rootç”¨æˆ·ï¼Œåˆ™æ·»åŠ ç¯å¢ƒå˜é‡ 1export KUBECONFIG=/etc/kubernetes/admin.conf å®‰è£…ç½‘ç»œæ’ä»¶calico ä¸‹è½½yamlæ–‡ä»¶ 1wget https://docs.projectcalico.org/v3.23/manifests/calico.yaml --no-check-certificate ç¡®è®¤é•œåƒä¿¡æ¯ 1cat calico.yaml | grep -n image åˆ é™¤docker.io 1sed -i &#x27;s#docker.io/##g&#x27; calico.yaml å®‰è£…calico 1kubectl apply -f calico.yaml æŸ¥çœ‹å®‰è£…ç»“æœ 1kubectl get pod -n kube-system | grep calico ç¡®è®¤èŠ‚ç‚¹ä¿¡æ¯ 1kubectl get nodes èŠ‚ç‚¹çš„æ·»åŠ å’Œåˆ é™¤ ä½¿ç”¨ä¸»èŠ‚ç‚¹ç”Ÿæˆçš„tokenè„šæœ¬åœ¨å­èŠ‚ç‚¹æ‰§è¡Œå³å¯ã€‚æˆ–è€…é‡æ–°ç”Ÿæˆtoken 1kubeadm token create --print-join-command å…³é—­é©±é€ä»èŠ‚ç‚¹ 123456# æŠŠslave1çš„èµ„æºé©±èµ¶åˆ°å…¶ä»–èŠ‚ç‚¹ kubectl drain k8s-slave1 --ignore-daemonsets # æ ‡è®°slave1ä¸ºä¸å¯è°ƒåº¦ kubectl uncordon k8s-slave1 # ä»é›†ç¾¤åˆ é™¤slave1 kubectl delete node k8s-slave1 åœæ­¢ä¸»èŠ‚ç‚¹ 1kubectl drain node --ignore-daemonsets --delete-local-data --force é‡å¯ç³»ç»Ÿåé‡åˆ°çš„é—®é¢˜ çœ‹èŠ‚ç‚¹ä¿¡æ¯å‘ç°æŠ¥é”™The connection to the server 192.168.1.20:6443 was refused - did you specify the right host or port? æŸ¥çœ‹æ—¥å¿— 1journalctl -fu kubelet å‘ç°å¦‚ä¸‹é”™è¯¯ failed to get cgroup stats for â€œ&#x2F;system.slice&#x2F;docker.serviceâ€è¯¥é—®é¢˜åªä¼šå‘ç”Ÿåœ¨ CentOS ç³»ç»Ÿä¸Šï¼Œè€Œå¼•èµ·ä¸Šé¢çš„é—®é¢˜çš„åŸå› æ˜¯ kubelet å¯åŠ¨æ—¶ï¼Œä¼šæ‰§è¡ŒèŠ‚ç‚¹èµ„æºç»Ÿè®¡ï¼Œéœ€è¦ systemd ä¸­å¼€å¯å¯¹åº”çš„é€‰é¡¹ è§£å†³åŠæ³•å¦‚ä¸‹ï¼š ä¿®æ”¹æ–‡ä»¶ 1vi /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf 1234[Service]CPUAccounting=true ## æ·»åŠ  å¼€å¯systemd CPUç»Ÿè®¡åŠŸèƒ½MemoryAccounting=true ## æ·»åŠ  å¼€å¯systemd Memoryç»Ÿè®¡åŠŸèƒ½Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot; é‡å¯ Kubelet æœåŠ¡ï¼Œè®© kubelet é‡æ–°åŠ è½½é…ç½®ã€‚ 12systemctl daemon-reloadsystemctl restart kubelet é‡å¯å®Œ kubelet åç­‰ä¸€æ®µæ—¶é—´ï¼Œå†æ¬¡è§‚å¯Ÿ kubelet æ—¥å¿—ä¿¡æ¯ï¼Œç¡®è®¤æ¢å¤æ­£å¸¸ 1journalctl -u kubelet -n 10 å¦‚éœ€è½¬è½½è¯·è¯´æ˜å‡ºå¤„","categories":[{"name":"Kuberneteså®‰è£…","slug":"Kuberneteså®‰è£…","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%89%E8%A3%85/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"docker","slug":"docker","permalink":"http://jimoblivion.github.io/tags/docker/"}]},{"title":"èµåŠ©æˆ‘","slug":"èµåŠ©æˆ‘","date":"2023-07-12T05:39:49.000Z","updated":"2023-07-24T11:46:43.174Z","comments":true,"path":"2023/07/12/èµåŠ©æˆ‘/","link":"","permalink":"http://jimoblivion.github.io/2023/07/12/%E8%B5%9E%E5%8A%A9%E6%88%91/","excerpt":"","text":"æ”¯æŒæˆ‘","categories":[],"tags":[]}],"categories":[{"name":"Kuberneteså®‰è£…","slug":"Kuberneteså®‰è£…","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%89%E8%A3%85/"},{"name":"Kuberneteså®æˆ˜","slug":"Kuberneteså®æˆ˜","permalink":"http://jimoblivion.github.io/categories/Kubernetes%E5%AE%9E%E6%88%98/"}],"tags":[{"name":"k8s","slug":"k8s","permalink":"http://jimoblivion.github.io/tags/k8s/"},{"name":"Prometheus","slug":"Prometheus","permalink":"http://jimoblivion.github.io/tags/Prometheus/"},{"name":"helm","slug":"helm","permalink":"http://jimoblivion.github.io/tags/helm/"},{"name":"RBAC","slug":"RBAC","permalink":"http://jimoblivion.github.io/tags/RBAC/"},{"name":"initC","slug":"initC","permalink":"http://jimoblivion.github.io/tags/initC/"},{"name":"CronJob","slug":"CronJob","permalink":"http://jimoblivion.github.io/tags/CronJob/"},{"name":"StorageClass","slug":"StorageClass","permalink":"http://jimoblivion.github.io/tags/StorageClass/"},{"name":"pv","slug":"pv","permalink":"http://jimoblivion.github.io/tags/pv/"},{"name":"pvc","slug":"pvc","permalink":"http://jimoblivion.github.io/tags/pvc/"},{"name":"nfs","slug":"nfs","permalink":"http://jimoblivion.github.io/tags/nfs/"},{"name":"HostPath","slug":"HostPath","permalink":"http://jimoblivion.github.io/tags/HostPath/"},{"name":"EmptyDir","slug":"EmptyDir","permalink":"http://jimoblivion.github.io/tags/EmptyDir/"},{"name":"ConfigMap","slug":"ConfigMap","permalink":"http://jimoblivion.github.io/tags/ConfigMap/"},{"name":"Ingress","slug":"Ingress","permalink":"http://jimoblivion.github.io/tags/Ingress/"},{"name":"Service","slug":"Service","permalink":"http://jimoblivion.github.io/tags/Service/"},{"name":"HPA","slug":"HPA","permalink":"http://jimoblivion.github.io/tags/HPA/"},{"name":"DaemonSet","slug":"DaemonSet","permalink":"http://jimoblivion.github.io/tags/DaemonSet/"},{"name":"StatefulSet","slug":"StatefulSet","permalink":"http://jimoblivion.github.io/tags/StatefulSet/"},{"name":"deployment","slug":"deployment","permalink":"http://jimoblivion.github.io/tags/deployment/"},{"name":"label","slug":"label","permalink":"http://jimoblivion.github.io/tags/label/"},{"name":"pod","slug":"pod","permalink":"http://jimoblivion.github.io/tags/pod/"},{"name":"docker","slug":"docker","permalink":"http://jimoblivion.github.io/tags/docker/"}]}